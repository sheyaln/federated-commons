# Upstream Guard
#
# Prevents org-specific content from being merged into federated-commons.
# Runs on every PR to main with three checks:
#   1. File pattern guard - blocks org-specific file patterns
#   2. Identifier scan - blocks org-specific identifiers in added lines
#   3. Secret sniff - blocks credential-shaped strings via gitleaks
#
# Maintenance: when new org patterns emerge (domains, servers, prefixes),
# add them to the BLOCKED_IDENTIFIERS pattern below.

name: Upstream Guard

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================================
      # Step 1: File Pattern Guard
      # Blocks files that should never exist in the upstream repo.
      # These are org-specific override files that belong only in forks.
      # =====================================================================
      - name: File pattern guard
        run: |
          echo "Checking for org-specific file patterns in PR..."

          BLOCKED=$(git diff --name-only --diff-filter=ACMR origin/master...HEAD | grep -E \
            '(_local\.tf$|^config/(project|dns|secrets|apps)\.yml$|^ansible/inventory\.ini$|^terraform\.tfvars$|\.env$)' \
            | grep -v '\.example$' \
            | grep -v '\.j2$' \
            || true)

          if [ -n "$BLOCKED" ]; then
            echo "::error::Org-specific files detected in PR. These belong in your fork, not upstream."
            echo ""
            echo "Blocked files:"
            echo "$BLOCKED" | while read -r f; do echo "  - $f"; done
            echo ""
            echo "If this is a new example template, rename it with a .example suffix."
            exit 1
          fi

          echo "File pattern guard passed."

      # =====================================================================
      # Step 2: Identifier Scan
      # Scans added lines for org-specific identifiers that should not
      # appear in the generic upstream repo.
      # =====================================================================
      - name: Identifier scan
        run: |
          echo "Scanning added lines for org-specific identifiers..."

          # Pattern components (one per line for maintainability)
          BLOCKED_IDENTIFIERS='(dc-?iww|dciww\.(org|cc)|\biww\b'
          BLOCKED_IDENTIFIERS+='|\bobs-'
          # Production server IPs
          BLOCKED_IDENTIFIERS+='|51\.15\.139\.81|51\.158\.115\.87|51\.15\.199\.105'
          # Private network IPs for prod servers
          BLOCKED_IDENTIFIERS+='|172\.16\.0\.[235]'
          BLOCKED_IDENTIFIERS+=')'

          # Known false positives that are acceptable
          ALLOWLIST='DCWobs'

          # Extract only added lines from the diff (not deletions or context)
          ADDED_LINES=$(git diff --diff-filter=d origin/master...HEAD \
            | grep '^+' \
            | grep -v '^+++' \
            || true)

          if [ -z "$ADDED_LINES" ]; then
            echo "No added lines to scan."
            echo "Identifier scan passed."
            exit 0
          fi

          HITS=$(echo "$ADDED_LINES" \
            | grep -iE "$BLOCKED_IDENTIFIERS" \
            | grep -v "$ALLOWLIST" \
            || true)

          if [ -n "$HITS" ]; then
            echo "::error::Org-specific identifiers found in added lines."
            echo ""
            echo "Matches:"
            echo "$HITS" | head -20
            echo ""
            echo "Generalize these references before contributing upstream."
            echo "Use variables, placeholders (example.org, 192.0.2.x), or config references."
            exit 1
          fi

          echo "Identifier scan passed."

      # =====================================================================
      # Step 3: Secret Sniff
      # Uses gitleaks to detect credential-shaped strings in the PR diff.
      # =====================================================================
      - name: Secret sniff
        uses: gitleaks/gitleaks-action@v2 # TODO: Switch to trufflehog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
