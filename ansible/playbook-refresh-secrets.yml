---
- name: Refresh Secrets and Restart Services
  hosts: "{{ target_host_group }}"
  become: true
  gather_facts: true
  vars_prompt:
    - name: target_host_group
      prompt: "Enter the host group name from inventory.ini (tools-prod/tools-staging/management/authentik-prod)"
      private: false
      default: ""
    - name: target_service
      prompt: "Enter specific service name (or 'all' to refresh all services)"
      private: false
      default: "all"

  vars:
    # Map host groups to their typical services and group-vars
    group_services:
      tools-prod:
        - privacy-policy
        - outline
        - nextcloud-suite
      tools-staging:
        - privacy-policy
        - outline
        - nextcloud-suite
      management:
        - prometheus
        - grafana
        - netdata
        - portainer
        - loki
      authentik-prod:
        - authentik

    # Map services to their group-vars files (for services that use secrets)
    service_group_vars:
      outline: "group-vars/outline.yml"
      nextcloud-suite: "group-vars/nextcloud-suite.yml"
      authentik: "group-vars/authentik.yml"
      prometheus: "group-vars/management.yml"

  pre_tasks:
    - name: Validate target host group
      ansible.builtin.fail:
        msg: "Invalid host group '{{ target_host_group }}'. Valid options: tools-prod, tools-staging, management, authentik-prod"
      when: target_host_group not in ['tools-prod', 'tools-staging', 'management', 'authentik-prod']

    - name: Validate target service
      ansible.builtin.fail:
        msg: "Invalid service '{{ target_service }}' for host group '{{ target_host_group }}'. Valid options: {{ group_services[target_host_group] | join(', ') }}, all"
      when: 
        - target_service != 'all'
        - target_service not in group_services[target_host_group]

    - name: Check Scaleway environment variables
      ansible.builtin.fail:
        msg: "Missing required Scaleway environment variables. Please source env-setup.local.sh or set SCW_ACCESS_KEY, SCW_SECRET_KEY, SCW_DEFAULT_REGION, SCW_DEFAULT_PROJECT_ID"
      when: 
        - lookup('env', 'SCW_ACCESS_KEY') == '' or
          lookup('env', 'SCW_SECRET_KEY') == '' or
          lookup('env', 'SCW_DEFAULT_REGION') == '' or
          lookup('env', 'SCW_DEFAULT_PROJECT_ID') == ''
      delegate_to: localhost
      run_once: true

    - name: Display refresh information
      ansible.builtin.debug:
        msg: |
          ============================================
          REFRESHING SECRETS FOR: {{ target_host_group }}
          HOST: {{ inventory_hostname }}
          TARGET: {{ 'ALL SERVICES' if target_service == 'all' else target_service.upper() + ' SERVICE ONLY' }}
          SERVICES TO REFRESH: {{ group_services[target_host_group] | join(', ') if target_service == 'all' else target_service }}
          ============================================

  tasks:
    - name: Discover active services on host
      ansible.builtin.find:
        paths: /opt
        file_type: directory
        patterns: "{{ [target_service] if target_service != 'all' else group_services[target_host_group] }}"
      register: discovered_services

    - name: Display discovered services
      ansible.builtin.debug:
        msg: "Found active services: {{ discovered_services.files | map(attribute='path') | map('basename') | list }}"

    - name: Fail if no services found
      ansible.builtin.fail:
        msg: "No services found in /opt/ matching the expected services for {{ target_host_group }}. Please verify services are deployed."
      when: discovered_services.files | length == 0

    - name: Load common group-vars first
      ansible.builtin.include_vars:
        file: "group-vars/all.yml"

    - name: Load appropriate group-vars for discovered services
      ansible.builtin.include_vars:
        file: "{{ service_group_vars[item] }}"
      loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"
      when: item in service_group_vars
      ignore_errors: true

    - name: Display loaded variables for debugging
      ansible.builtin.debug:
        msg: "Processing service: {{ item }} - group-vars file: {{ service_group_vars[item] if item in service_group_vars else 'none' }}"
      loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"

    - name: Refresh secrets and restart services
      block:
        - name: Define role path mapping
          ansible.builtin.set_fact:
            role_mapping:
              authentik: "authentik/authentik"
              prometheus: "management/prometheus"
              grafana: "management/grafana"
              netdata: "management/netdata"
              portainer: "management/portainer"
              loki: "management/loki"
              komodo: "management/komodo"
              uptime-kuma: "management/uptime-kuma"
              rancher: "management/rancher"

        - name: Re-render docker-compose files (refreshes secrets)
          ansible.builtin.template:
            src: "roles/{{ role_mapping[service_name] | default('tools/' + service_name) }}/templates/docker-compose.yml.j2"
            dest: "/opt/{{ service_name }}/docker-compose.yml"
            mode: '0644'
            owner: ubuntu
            group: ubuntu
          loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"
          loop_control:
            loop_var: current_service
          vars:
            service_name: "{{ current_service }}"
          failed_when: false
          register: docker_compose_results
          when: current_service != 'nextcloud-suite'

        - name: Copy static docker-compose file for nextcloud-suite
          ansible.builtin.copy:
            src: "roles/tools/nextcloud-suite/files/docker-compose.yml"
            dest: "/opt/nextcloud-suite/docker-compose.yml"
            mode: '0644'
            owner: ubuntu
            group: ubuntu
          when: current_service == 'nextcloud-suite'
          loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"
          loop_control:
            loop_var: current_service
          failed_when: false
          register: docker_compose_results

        - name: Show docker-compose template results
          ansible.builtin.debug:
            msg: "{{ service_name }}: {{ 'UPDATED' if not item.failed else 'SKIPPED (no template)' }}"
          loop: "{{ docker_compose_results.results }}"
          vars:
            service_name: "{{ item.current_service }}"

        - name: Re-render environment files (refreshes secrets)
          ansible.builtin.template:
            src: "roles/{{ role_mapping[service_name] | default('tools/' + service_name) }}/templates/env.j2"
            dest: "/opt/{{ service_name }}/.env"
            mode: '0600'
            owner: ubuntu
            group: ubuntu
          loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"
          loop_control:
            loop_var: current_service
          vars:
            service_name: "{{ current_service }}"
          failed_when: false
          register: env_results

        - name: Show environment template results
          ansible.builtin.debug:
            msg: "{{ service_name }}: {{ 'UPDATED' if not item.failed else 'SKIPPED (no template)' }}"
          loop: "{{ env_results.results }}"
          vars:
            service_name: "{{ item.current_service }}"

        - name: Restart services with refreshed secrets
          community.docker.docker_compose_v2:
            project_src: "/opt/{{ item }}"
            state: present
            recreate: always
          loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"
          register: service_startup

        - name: Wait for services to be ready
          ansible.builtin.pause:
            seconds: 5

        - name: Verify services are running
          ansible.builtin.shell: |
            cd "/opt/{{ item }}" && docker-compose ps --format json 2>/dev/null || echo "[]"
          loop: "{{ discovered_services.files | map(attribute='path') | map('basename') | list }}"
          register: service_status
          ignore_errors: true

        - name: Display service status
          ansible.builtin.debug:
            msg: |
              Service: {{ item.item }}
              Status: {{ 'RUNNING' if item.stdout != '[]' and 'Up' in item.stdout else 'FAILED' }}
              Output: {{ item.stdout if item.stdout != '[]' else 'No containers found' }}
          loop: "{{ service_status.results }}"
          when: service_status is defined

      rescue:
        - name: Handle refresh failure
          ansible.builtin.debug:
            msg: |
              ⚠️  SECRET REFRESH FAILED ⚠️
              Some services may need manual attention.
              Check docker logs: docker-compose -f /opt/SERVICE_NAME/docker-compose.yml logs

  post_tasks:
    - name: Generate refresh summary
      ansible.builtin.debug:
        msg: |
          ============================================
          SECRET REFRESH COMPLETED FOR: {{ target_host_group }}
          HOST: {{ inventory_hostname }}
          TARGET: {{ 'ALL SERVICES' if target_service == 'all' else target_service.upper() + ' SERVICE ONLY' }}
          SERVICES REFRESHED: {{ discovered_services.files | map(attribute='path') | map('basename') | list | join(', ') }}
          
          NEXT STEPS:
          1. Check service health: docker ps
          2. Check logs if needed: docker-compose -f /opt/SERVICE_NAME/docker-compose.yml logs
          3. Test service functionality
          ============================================

    - name: Final health check
      ansible.builtin.shell: |
        echo "=== DOCKER CONTAINER STATUS ==="
        docker ps
      register: final_status
      ignore_errors: true

    - name: Display final status
      ansible.builtin.debug:
        var: final_status.stdout_lines 