# Grafana Configuration
GF_SERVER_ROOT_URL=https://grafana.{{ monitoring_domain }}
GF_SERVER_DOMAIN=grafana.{{ monitoring_domain }}

# Plugins
GF_PLUGINS_PREINSTALL={{ grafana_plugins | join(',') }}

# Logging
GF_LOG_MODE=console
GF_LOG_LEVEL=info

# Security - Admin credentials set via grafana-cli or API after first boot
# Note: GF_SECURITY_ADMIN_USER and GF_SECURITY_ADMIN_PASSWORD do not work via env vars
# Use provisioning or grafana-cli to set admin password

# Anonymous access
GF_AUTH_ANONYMOUS_ENABLED=false

# OAuth/SSO via Authentik
{% if grafana_oauth_enabled | default(false) %}
GF_AUTH_GENERIC_OAUTH_ENABLED=true
GF_AUTH_GENERIC_OAUTH_NAME=Authentik
GF_AUTH_GENERIC_OAUTH_CLIENT_ID={{ grafana_oauth_client_id }}
GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET={{ grafana_oauth_client_secret | replace('$', '$$') }}
GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email offline_access groups
GF_AUTH_GENERIC_OAUTH_AUTH_URL={{ authentik_oauth_auth_url }}
GF_AUTH_GENERIC_OAUTH_TOKEN_URL={{ authentik_oauth_token_url }}
GF_AUTH_GENERIC_OAUTH_API_URL={{ authentik_oauth_api_url }}
GF_AUTH_GENERIC_OAUTH_SIGNOUT_REDIRECT_URL={{ authentik_oauth_signout_url }}
GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=preferred_username
GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
GF_AUTH_GENERIC_OAUTH_USE_REFRESH_TOKEN=true
GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_STRICT=true

# Role mapping from Authentik groups
# admin group -> Admin role, union-delegate group -> Editor role, others -> Viewer
GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], 'admin') && 'Admin' || contains(groups[*], 'union-delegate') && 'Editor' || 'Viewer'
GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
{% else %}
# OAuth disabled - credentials not found in Scaleway secrets
# Deploy terraform-authentik first to create the grafana app
GF_AUTH_GENERIC_OAUTH_ENABLED=false
{% endif %}

# Zabbix Database Configuration (Managed PostgreSQL)
# Note: $ characters are escaped as $$ for docker compose
ZABBIX_DB_HOST={{ zabbix_db_host }}
ZABBIX_DB_PORT={{ zabbix_db_port }}
ZABBIX_DB_NAME={{ zabbix_db_name }}
ZABBIX_DB_USER={{ zabbix_db_user }}
ZABBIX_DB_PASSWORD={{ zabbix_db_password | replace('$', '$$') }}
