global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_scrape_interval }}
  external_labels:
    cluster: "{{ project_name | default('obs') }}"
    environment: production

rule_files:
  - "rules/*.yml"

alerting:
  alertmanagers: []

scrape_configs:
  # Prometheus self-monitoring
  - job_name: prometheus
    static_configs:
      - targets: ['localhost:9090']
        labels:
          server: management
          instance_name: prometheus

  # Loki metrics
  - job_name: loki
    static_configs:
      - targets: ['loki:3100']
        labels:
          server: management
          instance_name: loki

  # Grafana metrics
  - job_name: grafana
    static_configs:
      - targets: ['grafana:3000']
        labels:
          server: management
          instance_name: grafana

  # ========================================
  # Management Server Exporters
  # ========================================
  - job_name: node-management
    static_configs:
      - targets: ['{{ server_ips.management }}:{{ exporter_ports.node_exporter }}']
        labels:
          server: management
          environment: management

  - job_name: cadvisor-management
    static_configs:
      - targets: ['{{ server_ips.management }}:{{ exporter_ports.cadvisor }}']
        labels:
          server: management
          environment: management

  - job_name: traefik-management
    static_configs:
      - targets: ['{{ server_ips.management }}:{{ traefik_metrics_ports.management }}']
        labels:
          server: management
          environment: management
          traefik_instance: management

  # ========================================
  # Tools-Prod Server Exporters
  # ========================================
  - job_name: node-tools-prod
    static_configs:
      - targets: ['{{ server_ips["tools-prod"] }}:{{ exporter_ports.node_exporter }}']
        labels:
          server: tools-prod
          environment: production

  - job_name: cadvisor-tools-prod
    static_configs:
      - targets: ['{{ server_ips["tools-prod"] }}:{{ exporter_ports.cadvisor }}']
        labels:
          server: tools-prod
          environment: production

  - job_name: traefik-tools-prod
    static_configs:
      - targets: ['{{ server_ips["tools-prod"] }}:{{ traefik_metrics_ports["tools-prod"] }}']
        labels:
          server: tools-prod
          environment: production
          traefik_instance: tools-prod

  # ========================================
  # Authentik Server Exporters
  # ========================================
  - job_name: node-authentik
    static_configs:
      - targets: ['{{ server_ips.authentik }}:{{ exporter_ports.node_exporter }}']
        labels:
          server: authentik
          environment: production

  - job_name: cadvisor-authentik
    static_configs:
      - targets: ['{{ server_ips.authentik }}:{{ exporter_ports.cadvisor }}']
        labels:
          server: authentik
          environment: production

  - job_name: traefik-authentik
    static_configs:
      - targets: ['{{ server_ips.authentik }}:{{ traefik_metrics_ports.authentik }}']
        labels:
          server: authentik
          environment: production
          traefik_instance: authentik

  # ========================================
  # Application Metrics
  # ========================================
{% if enable_authentik_metrics | default(true) %}
  # Authentik application metrics
  - job_name: authentik-app
    static_configs:
      - targets: ['{{ server_ips.authentik }}:{{ app_metrics_ports.authentik }}']
        labels:
          server: authentik
          application: authentik
          environment: production
{% endif %}

{% if enable_nextcloud_metrics | default(false) %}
  # Nextcloud metrics (via nextcloud-exporter)
  - job_name: nextcloud
    static_configs:
      - targets: ['{{ server_ips["tools-prod"] }}:9205']
        labels:
          server: tools-prod
          application: nextcloud
          environment: production
{% endif %}
