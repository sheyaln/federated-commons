services:
  vikunja:
    image: vikunja/vikunja:latest
    container_name: vikunja
    restart: unless-stopped

    volumes:
      - /opt/vikunja/files:/app/vikunja/files

    environment:
      TZ: America/New_York
      VIKUNJA_SERVICE_TIMEZONE: America/New_York
      VIKUNJA_DEFAULTSETTINGS_WEEK_START: "1"
      VIKUNJA_SERVICE_PUBLICURL: https://tasks.{{ default_domain | default(tools_domain) }}
      VIKUNJA_SERVICE_JWTSECRET: ${VIKUNJA_SERVICE_JWTSECRET}
      VIKUNJA_SERVICE_ENABLEREGISTRATION: "false"
      VIKUNJA_AUTH_LOCAL_ENABLED: "false"
      
      # Database configuration
      VIKUNJA_DATABASE_HOST: ${VIKUNJA_DATABASE_HOST}
      VIKUNJA_DATABASE_PASSWORD: ${VIKUNJA_DATABASE_PASSWORD}
      VIKUNJA_DATABASE_TYPE: postgres
      VIKUNJA_DATABASE_USER: ${VIKUNJA_DATABASE_USER}
      VIKUNJA_DATABASE_DATABASE: ${VIKUNJA_DATABASE_DATABASE}
      
      # OIDC Authentication
      VIKUNJA_AUTH_OPENID_ENABLED: "true"
      VIKUNJA_AUTH_OPENID_REDIRECTURL: https://tasks.{{ default_domain | default(tools_domain) }}/auth/openid/authentik
      VIKUNJA_AUTH_OPENID_PROVIDERS_AUTHENTIK_NAME: Authentik
      VIKUNJA_AUTH_OPENID_PROVIDERS_AUTHENTIK_AUTHURL: ${VIKUNJA_AUTH_OPENID_AUTHURL}
      VIKUNJA_AUTH_OPENID_PROVIDERS_AUTHENTIK_LOGOUTURL: ${VIKUNJA_AUTH_OPENID_LOGOUTURL}
      VIKUNJA_AUTH_OPENID_PROVIDERS_AUTHENTIK_CLIENTID: ${VIKUNJA_AUTH_OPENID_CLIENTID}
      VIKUNJA_AUTH_OPENID_PROVIDERS_AUTHENTIK_CLIENTSECRET: ${VIKUNJA_AUTH_OPENID_CLIENTSECRET}
      # Request vikunja_scope to get team assignment via vikunja_groups claim
      VIKUNJA_AUTH_OPENID_PROVIDERS_AUTHENTIK_SCOPE: "openid profile email vikunja_scope"
      
      # Mail configuration
      VIKUNJA_MAILER_ENABLED: "true"
      VIKUNJA_MAILER_HOST: ${VIKUNJA_MAILER_HOST}
      VIKUNJA_MAILER_PORT: ${VIKUNJA_MAILER_PORT}
      VIKUNJA_MAILER_USERNAME: ${VIKUNJA_MAILER_USERNAME}
      VIKUNJA_MAILER_PASSWORD: ${VIKUNJA_MAILER_PASSWORD}
      VIKUNJA_MAILER_FROMEMAIL: ${VIKUNJA_MAILER_FROMEMAIL}
      VIKUNJA_MAILER_SKIPTLSVERIFY: "false"

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.vikunja.loadbalancer.server.port=3456"
      
      - "traefik.http.routers.vikunja.rule=Host(`tasks.{{ default_domain | default(tools_domain) }}`)"
      - "traefik.http.routers.vikunja.entrypoints=websecure"
      - "traefik.http.routers.vikunja.tls.certresolver=le"
      - "traefik.http.routers.vikunja.service=vikunja"
      
      - "traefik.docker.network=traefik"
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=production"

    networks:
      - traefik
{% if db_type == 'local' %}
      - {{ local_postgres_network }}
{% endif %}

    security_opt:
      - no-new-privileges:true

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

networks:
  traefik:
    external: true
{% if db_type == 'local' %}
  {{ local_postgres_network }}:
    external: true
{% endif %}
