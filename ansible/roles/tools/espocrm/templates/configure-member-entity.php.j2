<?php
/**
 * EspoCRM Member Entity Configuration Script
 * 
 * Creates custom Member and DuesPayment entities for union constituent management.
 * Configures role-based field-level security.
 */

$basePath = '/var/www/html';
$customPath = $basePath . '/custom/Espo/Custom/Resources/metadata';

// Ensure custom directories exist
$directories = [
    $customPath . '/entityDefs',
    $customPath . '/scopes',
    $customPath . '/clientDefs',
    $customPath . '/entityAcl',
    $basePath . '/custom/Espo/Custom/Resources/layouts/Member',
    $basePath . '/custom/Espo/Custom/Resources/layouts/DuesPayment',
    $basePath . '/custom/Espo/Custom/Resources/i18n/en_US',
    $basePath . '/custom/Espo/Custom/Controllers',
    $basePath . '/custom/Espo/Custom/Entities',
    $basePath . '/custom/Espo/Custom/Repositories',
];

foreach ($directories as $dir) {
    if (!is_dir($dir)) {
        mkdir($dir, 0755, true);
        echo "Created directory: $dir\n";
    }
}

// ============================================================================
// PHP CLASS FILES (Required for EspoCRM to recognize custom entities)
// ============================================================================

// Member Controller
$memberController = <<<'PHP'
<?php
namespace Espo\Custom\Controllers;

class Member extends \Espo\Core\Templates\Controllers\Base
{
}
PHP;
file_put_contents($basePath . '/custom/Espo/Custom/Controllers/Member.php', $memberController);
echo "Created: Controllers/Member.php\n";

// Member Entity
$memberEntity = <<<'PHP'
<?php
namespace Espo\Custom\Entities;

class Member extends \Espo\Core\Templates\Entities\Base
{
    public const ENTITY_TYPE = 'Member';
}
PHP;
file_put_contents($basePath . '/custom/Espo/Custom/Entities/Member.php', $memberEntity);
echo "Created: Entities/Member.php\n";

// Member Repository
$memberRepository = <<<'PHP'
<?php
namespace Espo\Custom\Repositories;

class Member extends \Espo\Core\Templates\Repositories\Base
{
}
PHP;
file_put_contents($basePath . '/custom/Espo/Custom/Repositories/Member.php', $memberRepository);
echo "Created: Repositories/Member.php\n";

// DuesPayment Controller
$duesPaymentController = <<<'PHP'
<?php
namespace Espo\Custom\Controllers;

class DuesPayment extends \Espo\Core\Templates\Controllers\Base
{
}
PHP;
file_put_contents($basePath . '/custom/Espo/Custom/Controllers/DuesPayment.php', $duesPaymentController);
echo "Created: Controllers/DuesPayment.php\n";

// DuesPayment Entity
$duesPaymentEntity = <<<'PHP'
<?php
namespace Espo\Custom\Entities;

class DuesPayment extends \Espo\Core\Templates\Entities\Base
{
    public const ENTITY_TYPE = 'DuesPayment';
}
PHP;
file_put_contents($basePath . '/custom/Espo/Custom/Entities/DuesPayment.php', $duesPaymentEntity);
echo "Created: Entities/DuesPayment.php\n";

// DuesPayment Repository
$duesPaymentRepository = <<<'PHP'
<?php
namespace Espo\Custom\Repositories;

class DuesPayment extends \Espo\Core\Templates\Repositories\Base
{
}
PHP;
file_put_contents($basePath . '/custom/Espo/Custom/Repositories/DuesPayment.php', $duesPaymentRepository);
echo "Created: Repositories/DuesPayment.php\n";

echo "\nPHP class files created.\n";

// ============================================================================
// MEMBER ENTITY DEFINITION
// ============================================================================

$memberEntityDefs = [
    'fields' => [
        'name' => [
            'type' => 'personName',
            'isPersonalData' => true
        ],
        'firstName' => [
            'type' => 'varchar',
            'maxLength' => 100,
            'required' => true,
            'pattern' => '$noBadCharacters'
        ],
        'lastName' => [
            'type' => 'varchar',
            'maxLength' => 100,
            'required' => true,
            'pattern' => '$noBadCharacters'
        ],
        'xNumber' => [
            'type' => 'varchar',
            'maxLength' => 20,
            'required' => true,
            'validatorClassNameList' => [],
            'tooltip' => true
        ],
        'email' => [
            'type' => 'email',
            'isPersonalData' => true
        ],
        'phoneNumber' => [
            'type' => 'phone',
            'isPersonalData' => true
        ],
        'city' => [
            'type' => 'varchar',
            'maxLength' => 100
        ],
        'streetAddress' => [
            'type' => 'varchar',
            'maxLength' => 255,
            'isPersonalData' => true
        ],
        'state' => [
            'type' => 'varchar',
            'maxLength' => 50
        ],
        'industrialUnit' => [
            'type' => 'varchar',
            'maxLength' => 255,
            'tooltip' => true
        ],
        'postalCode' => [
            'type' => 'varchar',
            'maxLength' => 20,
            'isPersonalData' => true
        ],
        'membershipStatus' => [
            'type' => 'enum',
            'options' => [
                'Good Standing',
                'In Arrears',
                'Suspended',
                'Expelled',
                'Withdrawn',
                'Deceased'
            ],
            'default' => 'Good Standing',
            'style' => [
                'Good Standing' => 'success',
                'In Arrears' => 'warning',
                'Suspended' => 'danger',
                'Expelled' => 'danger',
                'Withdrawn' => 'info',
                'Deceased' => 'default'
            ]
        ],
        'duesTier' => [
            'type' => 'enum',
            'options' => [
                '8',
                '11',
                '22',
                '33'
            ],
            'default' => '11'
        ],
        'branchMembership' => [
            'type' => 'enum',
            'options' => [
                'Reports to Branch',
                'At Large',
                'Re-initiated'
            ],
            'default' => 'Reports to Branch',
            'style' => [
                'Reports to Branch' => 'success',
                'At Large' => 'warning',
                'Re-initiated' => 'info'
            ]
        ],
        'joinDate' => [
            'type' => 'date'
        ],
        'lastDuesDate' => [
            'type' => 'date',
            'readOnly' => true
        ],
        'assignedUser' => [
            'type' => 'link',
            'required' => false
        ],
        'teams' => [
            'type' => 'linkMultiple'
        ],
        'duesPayments' => [
            'type' => 'linkMultiple',
            'readOnly' => true,
            'columns' => [
                'amount' => 'amount',
                'paymentDate' => 'paymentDate'
            ]
        ],
        'createdAt' => [
            'type' => 'datetime',
            'readOnly' => true
        ],
        'modifiedAt' => [
            'type' => 'datetime',
            'readOnly' => true
        ],
        'createdBy' => [
            'type' => 'link',
            'readOnly' => true
        ],
        'modifiedBy' => [
            'type' => 'link',
            'readOnly' => true
        ],
        'description' => [
            'type' => 'text'
        ]
    ],
    'links' => [
        'assignedUser' => [
            'type' => 'belongsTo',
            'entity' => 'User'
        ],
        'teams' => [
            'type' => 'hasMany',
            'entity' => 'Team',
            'relationName' => 'entityTeam',
            'layoutRelationshipsDisabled' => true
        ],
        'duesPayments' => [
            'type' => 'hasMany',
            'entity' => 'DuesPayment',
            'foreign' => 'member'
        ],
        'createdBy' => [
            'type' => 'belongsTo',
            'entity' => 'User'
        ],
        'modifiedBy' => [
            'type' => 'belongsTo',
            'entity' => 'User'
        ]
    ],
    'collection' => [
        'orderBy' => 'lastName',
        'order' => 'asc',
        'textFilterFields' => ['name', 'xNumber', 'email', 'city', 'industrialUnit']
    ],
    'indexes' => [
        'xNumber' => [
            'columns' => ['xNumber'],
            'unique' => true
        ],
        'membershipStatus' => [
            'columns' => ['membershipStatus']
        ],
        'assignedUser' => [
            'columns' => ['assignedUserId']
        ]
    ]
];

// ============================================================================
// DUES PAYMENT ENTITY DEFINITION
// ============================================================================

$duesPaymentEntityDefs = [
    'fields' => [
        'name' => [
            'type' => 'varchar',
            'required' => false,
            'readOnly' => true
        ],
        'member' => [
            'type' => 'link',
            'required' => true
        ],
        'amount' => [
            'type' => 'currency',
            'required' => true
        ],
        'paymentDate' => [
            'type' => 'date',
            'required' => true,
            'default' => 'javascript: return this.dateTime.getToday();'
        ],
        'method' => [
            'type' => 'enum',
            'options' => [
                'Cash',
                'Cashapp',
                'Zelle',
                'Venmo',
                'PayPal',
                'Bank Transfer',
                'Other'
            ],
            'default' => 'Cash'
        ],
        'coversUntil' => [
            'type' => 'date',
            'required' => true
        ],
        'receiptNumber' => [
            'type' => 'varchar',
            'maxLength' => 50
        ],
        'notes' => [
            'type' => 'text'
        ],
        'createdAt' => [
            'type' => 'datetime',
            'readOnly' => true
        ],
        'modifiedAt' => [
            'type' => 'datetime',
            'readOnly' => true
        ],
        'createdBy' => [
            'type' => 'link',
            'readOnly' => true
        ],
        'modifiedBy' => [
            'type' => 'link',
            'readOnly' => true
        ]
    ],
    'links' => [
        'member' => [
            'type' => 'belongsTo',
            'entity' => 'Member',
            'foreign' => 'duesPayments'
        ],
        'createdBy' => [
            'type' => 'belongsTo',
            'entity' => 'User'
        ],
        'modifiedBy' => [
            'type' => 'belongsTo',
            'entity' => 'User'
        ]
    ],
    'collection' => [
        'orderBy' => 'paymentDate',
        'order' => 'desc'
    ],
    'indexes' => [
        'member' => [
            'columns' => ['memberId']
        ],
        'paymentDate' => [
            'columns' => ['paymentDate']
        ]
    ]
];

// ============================================================================
// SCOPE DEFINITIONS (Entity registration)
// ============================================================================

$memberScopes = [
    'entity' => true,
    'object' => true,
    'module' => 'Custom',
    'tab' => true,
    'acl' => true,
    'aclPortal' => true,
    'customizable' => true,
    'importable' => true,
    'notifications' => true,
    'stream' => true,
    'disabled' => false,
    'type' => 'Base',
    'isCustom' => true
];

$duesPaymentScopes = [
    'entity' => true,
    'object' => true,
    'module' => 'Custom',
    'tab' => true,
    'acl' => true,
    'aclPortal' => false,
    'customizable' => true,
    'importable' => true,
    'notifications' => false,
    'stream' => false,
    'disabled' => false,
    'type' => 'Base',
    'isCustom' => true
];

// ============================================================================
// CLIENT DEFINITIONS (UI configuration)
// ============================================================================

$memberClientDefs = [
    'controller' => 'controllers/record',
    'iconClass' => 'fas fa-users',
    'color' => '#6c5ce7',
    'kanbanViewMode' => false,
    'boolFilterList' => [
        'onlyMy'
    ],
    'filterList' => [
        [
            'name' => 'goodStanding',
            'filter' => [
                'membershipStatus' => 'Good Standing'
            ]
        ],
        [
            'name' => 'inArrears',
            'filter' => [
                'membershipStatus' => 'In Arrears'
            ]
        ],
        [
            'name' => 'reportsToBranch',
            'filter' => [
                'branchMembership' => 'Reports to Branch'
            ]
        ],
        [
            'name' => 'atLarge',
            'filter' => [
                'branchMembership' => 'At Large'
            ]
        ],
        [
            'name' => 'reInitiated',
            'filter' => [
                'branchMembership' => 'Re-initiated'
            ]
        ]
    ],
    'defaultFilterData' => [
        'all' => []
    ],
    'createDisabled' => false,
    'searchPanelDisabled' => false,
    // Relationship panels configuration (bottom panels)
    'relationshipPanels' => [
        'duesPayments' => [
            'create' => true,
            'select' => false,
            'rowActionsView' => 'views/record/row-actions/relationship',
            'orderBy' => 'paymentDate',
            'order' => 'desc'
        ]
    ]
];

$duesPaymentClientDefs = [
    'controller' => 'controllers/record',
    'iconClass' => 'fas fa-dollar-sign',
    'color' => '#00b894'
];

// ============================================================================
// ENTITY ACL DEFINITIONS (Field-level security)
// ============================================================================

$memberEntityAcl = [
    'fields' => [
        'streetAddress' => [
            'readOnlyRoles' => ['Delegate'],
            'hiddenRoles' => ['Delegate', 'Treasurer']
        ],
        'state' => [
            'readOnlyRoles' => ['Delegate'],
            'hiddenRoles' => ['Delegate', 'Treasurer']
        ],
        'postalCode' => [
            'readOnlyRoles' => ['Delegate'],
            'hiddenRoles' => ['Delegate', 'Treasurer']
        ]
    ]
];

// ============================================================================
// LAYOUTS
// ============================================================================

$memberDetailLayout = [
    [
        'label' => 'Overview',
        'rows' => [
            [
                ['name' => 'xNumber'],
                ['name' => 'membershipStatus']
            ],
            [
                ['name' => 'firstName'],
                ['name' => 'lastName']
            ],
            [
                ['name' => 'email'],
                ['name' => 'phoneNumber']
            ],
            [
                ['name' => 'duesTier'],
                ['name' => 'branchMembership']
            ],
            [
                ['name' => 'industrialUnit'],
                ['name' => 'joinDate']
            ],
            [
                ['name' => 'assignedUser'],
                false
            ]
        ]
    ],
    [
        'label' => 'Address',
        'rows' => [
            [
                ['name' => 'city'],
                ['name' => 'state']
            ],
            [
                ['name' => 'streetAddress'],
                ['name' => 'postalCode']
            ]
        ]
    ],
    [
        'label' => 'Description',
        'rows' => [
            [
                ['name' => 'description', 'fullWidth' => true]
            ]
        ]
    ]
];

$memberListLayout = [
    ['name' => 'xNumber', 'width' => 8],
    ['name' => 'name', 'width' => 15, 'link' => true],
    ['name' => 'email', 'width' => 15],
    ['name' => 'city', 'width' => 10],
    ['name' => 'industrialUnit', 'width' => 14],
    ['name' => 'membershipStatus', 'width' => 12],
    ['name' => 'branchMembership', 'width' => 12],
    ['name' => 'assignedUser', 'width' => 10]
];

$duesPaymentDetailLayout = [
    [
        'label' => 'Overview',
        'rows' => [
            [
                ['name' => 'member'],
                ['name' => 'paymentDate']
            ],
            [
                ['name' => 'amount'],
                ['name' => 'method']
            ],
            [
                ['name' => 'coversUntil'],
                ['name' => 'receiptNumber']
            ],
            [
                ['name' => 'notes', 'fullWidth' => true]
            ]
        ]
    ]
];

$duesPaymentListLayout = [
    ['name' => 'member', 'width' => 25, 'link' => true],
    ['name' => 'amount', 'width' => 15],
    ['name' => 'paymentDate', 'width' => 15],
    ['name' => 'method', 'width' => 15],
    ['name' => 'coversUntil', 'width' => 20],
    ['name' => 'receiptNumber', 'width' => 10]
];

// Small list layout for relationship panels (no member column since it's obvious)
$duesPaymentListSmallLayout = [
    ['name' => 'paymentDate', 'width' => 20],
    ['name' => 'amount', 'width' => 20],
    ['name' => 'method', 'width' => 20],
    ['name' => 'coversUntil', 'width' => 25],
    ['name' => 'receiptNumber', 'width' => 15]
];

// Quick create / detail small layout for DuesPayment modal
$duesPaymentDetailSmallLayout = [
    [
        'rows' => [
            [
                ['name' => 'member'],
                ['name' => 'paymentDate']
            ],
            [
                ['name' => 'amount'],
                ['name' => 'method']
            ],
            [
                ['name' => 'coversUntil'],
                ['name' => 'receiptNumber']
            ]
        ]
    ]
];

// Relationships layout for Member detail view (array format required by EspoCRM)
$memberRelationshipsLayout = [
    [
        'name' => 'duesPayments'
    ]
];

// ============================================================================
// LANGUAGE LABELS
// ============================================================================

$memberLabels = [
    'labels' => [
        'Create Member' => 'Create Member',
        'Record Payment' => 'Record Payment'
    ],
    'fields' => [
        'xNumber' => 'X Number',
        'firstName' => 'First Name',
        'lastName' => 'Last Name',
        'name' => 'Name',
        'email' => 'Email',
        'phoneNumber' => 'Phone',
        'city' => 'City',
        'streetAddress' => 'Street Address',
        'state' => 'State',
        'industrialUnit' => 'Industrial Unit (IU)',
        'postalCode' => 'Postal Code',
        'membershipStatus' => 'Membership Status',
        'duesTier' => 'Dues Tier',
        'branchMembership' => 'Branch Membership',
        'joinDate' => 'Join Date',
        'lastDuesDate' => 'Last Dues Date',
        'assignedUser' => 'Assigned Delegate',
        'duesPayments' => 'Dues Payments',
        'description' => 'Notes'
    ],
    'tooltips' => [
        'xNumber' => 'IWW membership card number (e.g., X123456)',
        'industrialUnit' => 'IWW Industrial Union number and name (e.g., Greenhouse and Nursery Workers IU 140)'
    ],
    'links' => [
        'duesPayments' => 'Dues Payments',
        'assignedUser' => 'Assigned Delegate'
    ],
    'options' => [
        'membershipStatus' => [
            'Good Standing' => 'Good Standing',
            'In Arrears' => 'In Arrears',
            'Suspended' => 'Suspended',
            'Expelled' => 'Expelled',
            'Withdrawn' => 'Withdrawn',
            'Deceased' => 'Deceased'
        ],
        'duesTier' => [
            '8' => '$8/month',
            '11' => '$11/month',
            '22' => '$22/month',
            '33' => '$33/month'
        ],
        'branchMembership' => [
            'Reports to Branch' => 'Reports to Branch',
            'At Large' => 'At Large',
            'Re-initiated' => 'Re-initiated'
        ]
    ],
    'filters' => [
        'goodStanding' => 'Good Standing',
        'reInitiated' => 'Re-initiated',
        'inArrears' => 'In Arrears',
        'reportsToBranch' => 'Reports to Branch',
        'atLarge' => 'At Large'
    ]
];

$duesPaymentLabels = [
    'labels' => [
        'Create DuesPayment' => 'Record Payment'
    ],
    'fields' => [
        'member' => 'Member',
        'amount' => 'Amount',
        'paymentDate' => 'Payment Date',
        'method' => 'Payment Method',
        'coversUntil' => 'Covers Until',
        'receiptNumber' => 'Receipt Number',
        'notes' => 'Notes'
    ],
    'tooltips' => [
        'coversUntil' => 'The date until which dues are paid'
    ],
    'links' => [
        'member' => 'Member'
    ],
    'options' => [
        'method' => [
            'Cash' => 'Cash',
            'Cashapp' => 'Cashapp',
            'Zelle' => 'Zelle',
            'Venmo' => 'Venmo',
            'PayPal' => 'PayPal',
            'Bank Transfer' => 'Bank Transfer',
            'Other' => 'Other'
        ]
    ]
];

$globalLabels = [
    'scopeNames' => [
        'Member' => 'Member',
        'DuesPayment' => 'Dues Payment'
    ],
    'scopeNamesPlural' => [
        'Member' => 'Members',
        'DuesPayment' => 'Dues Payments'
    ]
];

// ============================================================================
// WRITE ALL FILES
// ============================================================================

function writeJson($path, $data) {
    $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
    file_put_contents($path, $json);
    echo "Written: $path\n";
}

// Entity definitions
writeJson($customPath . '/entityDefs/Member.json', $memberEntityDefs);
writeJson($customPath . '/entityDefs/DuesPayment.json', $duesPaymentEntityDefs);

// Scopes
writeJson($customPath . '/scopes/Member.json', $memberScopes);
writeJson($customPath . '/scopes/DuesPayment.json', $duesPaymentScopes);

// Client definitions
writeJson($customPath . '/clientDefs/Member.json', $memberClientDefs);
writeJson($customPath . '/clientDefs/DuesPayment.json', $duesPaymentClientDefs);

// Entity ACL (field-level security)
writeJson($customPath . '/entityAcl/Member.json', $memberEntityAcl);

// Layouts
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/Member/detail.json', $memberDetailLayout);
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/Member/list.json', $memberListLayout);
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/Member/relationships.json', $memberRelationshipsLayout);
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/DuesPayment/detail.json', $duesPaymentDetailLayout);
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/DuesPayment/list.json', $duesPaymentListLayout);
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/DuesPayment/listSmall.json', $duesPaymentListSmallLayout);
writeJson($basePath . '/custom/Espo/Custom/Resources/layouts/DuesPayment/detailSmall.json', $duesPaymentDetailSmallLayout);

// Language files
writeJson($basePath . '/custom/Espo/Custom/Resources/i18n/en_US/Member.json', $memberLabels);
writeJson($basePath . '/custom/Espo/Custom/Resources/i18n/en_US/DuesPayment.json', $duesPaymentLabels);
writeJson($basePath . '/custom/Espo/Custom/Resources/i18n/en_US/Global.json', $globalLabels);

echo "\n";
echo "Entity metadata files created successfully.\n";

// ============================================================================
// CREATE ROLES VIA DATABASE
// ============================================================================

echo "\nConfiguring roles...\n";

// Connect to the database using EspoCRM's internal config format
$configPath = $basePath . '/data/config.php';
if (!file_exists($configPath)) {
    echo "Warning: Config file not found, skipping role configuration.\n";
    echo "Roles will need to be configured manually.\n";
} else {
    $config = include($configPath);
    
    // EspoCRM stores database config directly in root of config array
    $dbHost = $config['database']['host'] ?? ($config['databaseHost'] ?? '{{ ESPO_DB_HOST }}');
    $dbPort = $config['database']['port'] ?? ($config['databasePort'] ?? '{{ ESPO_DB_PORT }}');
    $dbName = $config['database']['dbname'] ?? ($config['databaseName'] ?? '{{ ESPO_DB_NAME }}');
    $dbUser = $config['database']['user'] ?? ($config['databaseUser'] ?? '{{ ESPO_DB_USER }}');
    $dbPass = $config['database']['password'] ?? ($config['databasePassword'] ?? '{{ ESPO_DB_PASS }}');
    
    try {
        $dsn = "pgsql:host=$dbHost;port=$dbPort;dbname=$dbName";
        $pdo = new PDO($dsn, $dbUser, $dbPass, [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
        ]);
        
        echo "Connected to database.\n";
        
        // Role definitions with permissions
        $roles = [
            [
                'name' => 'Admin',
                'data' => [
                    'Member' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'all',
                        'delete' => 'all',
                        'stream' => 'all'
                    ],
                    'DuesPayment' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'all',
                        'delete' => 'all'
                    ]
                ],
                'fieldData' => [
                    'Member' => [
                        'streetAddress' => ['read' => 'yes', 'edit' => 'yes'],
                        'state' => ['read' => 'yes', 'edit' => 'yes'],
                        'postalCode' => ['read' => 'yes', 'edit' => 'yes']
                    ]
                ]
            ],
            [
                'name' => 'Union Delegate',
                'data' => [
                    'Member' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'all',
                        'delete' => 'no',
                        'stream' => 'all'
                    ],
                    'DuesPayment' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'all',
                        'delete' => 'no'
                    ]
                ],
                'fieldData' => [
                    'Member' => [
                        'streetAddress' => ['read' => 'yes', 'edit' => 'yes'],
                        'state' => ['read' => 'yes', 'edit' => 'yes'],
                        'postalCode' => ['read' => 'yes', 'edit' => 'yes']
                    ]
                ]
            ],
            [
                'name' => 'Delegate',
                'data' => [
                    'Member' => [
                        'create' => 'no',
                        'read' => 'all',
                        'edit' => 'no',
                        'delete' => 'no',
                        'stream' => 'all'
                    ],
                    'DuesPayment' => [
                        'create' => 'no',
                        'read' => 'all',
                        'edit' => 'no',
                        'delete' => 'no'
                    ]
                ],
                'fieldData' => [
                    'Member' => [
                        'streetAddress' => ['read' => 'no', 'edit' => 'no'],
                        'state' => ['read' => 'no', 'edit' => 'no'],
                        'postalCode' => ['read' => 'no', 'edit' => 'no']
                    ]
                ]
            ],
            [
                'name' => 'Treasurer',
                'data' => [
                    'Member' => [
                        'create' => 'no',
                        'read' => 'no',
                        'edit' => 'no',
                        'delete' => 'no',
                        'stream' => 'no'
                    ],
                    'DuesPayment' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'all',
                        'delete' => 'no'
                    ]
                ],
                'fieldData' => [
                    'Member' => [
                        'streetAddress' => ['read' => 'no', 'edit' => 'no'],
                        'state' => ['read' => 'no', 'edit' => 'no'],
                        'postalCode' => ['read' => 'no', 'edit' => 'no']
                    ]
                ]
            ],
            [
                'name' => 'MCP Server',
                'data' => [
                    'Member' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'yes',
                        'delete' => 'no',
                        'stream' => 'no'
                    ],
                    'DuesPayment' => [
                        'create' => 'yes',
                        'read' => 'all',
                        'edit' => 'yes',
                        'delete' => 'no'
                    ]
                ],
                'fieldData' => [
                    'Member' => [
                        'streetAddress' => ['read' => 'yes', 'edit' => 'yes'],
                        'state' => ['read' => 'yes', 'edit' => 'yes'],
                        'postalCode' => ['read' => 'yes', 'edit' => 'yes']
                    ]
                ]
            ]
        ];
        
        foreach ($roles as $role) {
            // Generate shorter role IDs to fit the 17-character limit
            $roleIdMap = [
                'Admin' => 'admin_role',
                'Union Delegate' => 'union_del_role',
                'Delegate' => 'delegate_role',
                'Treasurer' => 'treasurer_role',
                'MCP Server' => 'mcp_role'
            ];
            $id = $roleIdMap[$role['name']] ?? strtolower(preg_replace('/[^a-zA-Z0-9]/', '', $role['name'])) . '_role';
            $name = $role['name'];
            $data = json_encode($role['data']);
            $fieldData = json_encode($role['fieldData']);
            
            // Check if role exists
            $stmt = $pdo->prepare("SELECT id FROM role WHERE name = ?");
            $stmt->execute([$name]);
            $existing = $stmt->fetch();
            
            if ($existing) {
                // Update existing role
                $stmt = $pdo->prepare("UPDATE role SET data = ?, field_data = ? WHERE name = ?");
                $stmt->execute([$data, $fieldData, $name]);
                echo "Updated role: $name\n";
            } else {
                // Create new role
                $stmt = $pdo->prepare("INSERT INTO role (id, name, data, field_data, deleted) VALUES (?, ?, ?, ?, false)");
                $stmt->execute([$id, $name, $data, $fieldData]);
                echo "Created role: $name\n";
            }
        }
        
        echo "Roles configured successfully.\n";
        
        // ============================================================================
        // CREATE TEAMS FOR ROLES
        // ============================================================================
        
        echo "\nConfiguring teams...\n";
        
        $teams = [
            [
                'name' => 'Admin Team',
                'roleId' => 'admin_role'
            ],
            [
                'name' => 'Union Delegates',
                'roleId' => 'union_del_role'
            ],
            [
                'name' => 'Delegates',
                'roleId' => 'delegate_role'
            ],
            [
                'name' => 'Treasurers',
                'roleId' => 'treasurer_role'
            ],
            [
                'name' => 'MCP Servers',
                'roleId' => 'mcp_role'
            ]
        ];
        
        foreach ($teams as $team) {
            $teamId = strtolower(preg_replace('/[^a-zA-Z0-9]/', '', $team['name']));
            $teamName = $team['name'];
            $roleId = $team['roleId'];
            
            // Check if team exists
            $stmt = $pdo->prepare("SELECT id FROM team WHERE name = ?");
            $stmt->execute([$teamName]);
            $existing = $stmt->fetch();
            
            if ($existing) {
                // Update existing team
                $stmt = $pdo->prepare("UPDATE team SET deleted = false WHERE name = ?");
                $stmt->execute([$teamName]);
                echo "Updated team: $teamName\n";
                $teamId = $existing['id'];
            } else {
                // Create new team
                $stmt = $pdo->prepare("INSERT INTO team (id, name, deleted, created_at) VALUES (?, ?, false, NOW())");
                $stmt->execute([$teamId, $teamName]);
                echo "Created team: $teamName\n";
            }
            
            // Link team to role (many-to-many relationship)
            $stmt = $pdo->prepare("SELECT * FROM role_team WHERE role_id = ? AND team_id = ? AND deleted = false");
            $stmt->execute([$roleId, $teamId]);
            $linkExists = $stmt->fetch();
            
            if (!$linkExists) {
                $stmt = $pdo->prepare("INSERT INTO role_team (role_id, team_id, deleted) VALUES (?, ?, false) ON CONFLICT (role_id, team_id) DO UPDATE SET deleted = false");
                $stmt->execute([$roleId, $teamId]);
                echo "  Linked to role: $roleId\n";
            }
        }
        
        echo "Teams configured successfully.\n";
        
    } catch (PDOException $e) {
        echo "Database error: " . $e->getMessage() . "\n";
        echo "Roles will need to be configured manually via the Admin UI.\n";
    }
}

// ============================================================================
// REBUILD DATABASE
// ============================================================================

echo "\nRebuilding EspoCRM...\n";

// Run rebuild command
chdir($basePath);
exec('php command.php rebuild 2>&1', $output, $returnCode);

if ($returnCode === 0) {
    echo "Rebuild completed successfully.\n";
} else {
    echo "Rebuild output:\n";
    echo implode("\n", $output) . "\n";
}

// ============================================================================
// CONFIGURE NAVBAR TABS
// ============================================================================

echo "\nConfiguring navigation tabs...\n";

// Read current config
$configPath = $basePath . '/data/config.php';
if (file_exists($configPath)) {
    $config = include($configPath);
    
    // Configure tab list - only show our custom entities and essential items
    $config['tabList'] = [
        'Member',
        'DuesPayment',
        '_delimiter_',
        'Calendar',
        'Email'
    ];
    
    // Configure tab groups (categories in the navbar)
    $config['tabGroups'] = [
        [
            'label' => 'CRM',
            'iconClass' => 'fas fa-address-book',
            'color' => '#6c5ce7',
            'itemList' => [
                'Member',
                'DuesPayment'
            ]
        ]
    ];
    
    // Quick create list - entities that can be created from the + button
    $config['quickCreateList'] = [
        'Member',
        'DuesPayment'
    ];
    
    // Global search - entities included in global search
    $config['globalSearchEntityList'] = [
        'Member',
        'DuesPayment'
    ];
    
    // Disable default CRM entities we don't need
    // These will be hidden from the UI but data preserved if any exists
    
    // Write updated config
    $configContent = "<?php\nreturn " . var_export($config, true) . ";\n";
    file_put_contents($configPath, $configContent);
    
    echo "Tab configuration updated.\n";
    echo "  - CRM group: Members, Dues Payments\n";
    echo "  - Removed: Accounts, Leads, Contacts, Opportunities, Cases\n";
} else {
    echo "Warning: Config file not found, skipping tab configuration.\n";
}

// ============================================================================
// DISABLE DEFAULT ENTITIES VIA SCOPES
// ============================================================================

echo "\nDisabling unused default entities...\n";

// Entities to disable (hide from UI but preserve data)
$disabledEntities = ['Account', 'Lead', 'Contact', 'Opportunity', 'Case', 'Campaign', 'TargetList', 'Target', 'Document', 'DocumentFolder'];

foreach ($disabledEntities as $entityName) {
    $scopePath = $customPath . "/scopes/{$entityName}.json";
    $scopeData = [
        'disabled' => true,
        'tab' => false
    ];
    writeJson($scopePath, $scopeData);
}

echo "Disabled entities: " . implode(', ', $disabledEntities) . "\n";

// Clear cache after all changes
echo "\nClearing cache...\n";
exec('php command.php clear-cache 2>&1', $cacheOutput, $cacheCode);
echo "Cache cleared.\n";

echo "\n";
echo "=================================================\n";
echo "Member entity configuration complete!\n";
echo "=================================================\n";
echo "\n";
echo "Custom entities created:\n";
echo "  - Member (constituent tracking)\n";
echo "  - DuesPayment (payment records)\n";
echo "\n";
echo "Navigation configured:\n";
echo "  - CRM tab group with Members and Dues Payments\n";
echo "  - Default entities (Accounts, Leads, etc.) hidden\n";
echo "\n";
echo "Member actions:\n";
echo "  - 'Record Payment' button on member detail view\n";
echo "  - Dues Payments panel showing payment history\n";
echo "\n";
echo "Roles configured:\n";
echo "  - Admin: Full access to all fields\n";
echo "  - Delegate: Read access, address fields hidden\n";
echo "  - Treasurer: Dues payment access only\n";
echo "\n";
