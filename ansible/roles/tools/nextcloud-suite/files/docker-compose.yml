---
services:
  # Redis - Shared caching for Nextcloud and OnlyOffice
  redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - nextcloud_network

  # OnlyOffice Document Server - Editing Engine
  documentserver:
    image: onlyoffice/documentserver:latest
    restart: always
    depends_on:
      - redis
    environment:
      # Database Configuration
      DB_TYPE: postgres
      DB_HOST: ${PG_HOST}
      DB_PORT: ${PG_PORT}
      DB_NAME: ${DOCS_DB_NAME}
      DB_USER: ${DOCS_DB_USER}
      DB_PWD: ${DOCS_DB_PASSWORD}
      
      # Redis Configuration  
      REDIS_SERVER_HOST: redis
      REDIS_SERVER_PORT: 6379
      REDIS_SERVER_PASS: ${REDIS_PASSWORD}
      
      # JWT Configuration
      JWT_ENABLED: ${JWT_ENABLED}
      JWT_SECRET: ${JWT_SECRET}
      JWT_HEADER: ${JWT_HEADER}
      JWT_IN_BODY: ${JWT_IN_BODY}
      
      # Security Configuration
      SECURE_LINK_SECRET: ${SECURE_LINK_SECRET}
      ALLOW_PRIVATE_IP_ADDRESS: "true"
      ALLOW_META_IP_ADDRESS: "false"
      
      # Performance Configuration
      NGINX_WORKER_PROCESSES: ${NGINX_WORKER_PROCESSES}
      NGINX_WORKER_CONNECTIONS: ${NGINX_WORKER_CONNECTIONS}
      GENERATE_FONTS: "true"
      PLUGINS_ENABLED: "true"
      WOPI_ENABLED: "false"
      METRICS_ENABLED: "false"
      
      # Enable example service for testing only
      DS_EXAMPLE_ENABLED: "false"
      DS_WELCOME_PAGE: "false"
      
      # Timeout Configuration to prevent 'connection too slow' errors
      ONLYOFFICE_HTTPS_HSTS_ENABLED: "false"
      ONLYOFFICE_HTTPS_HSTS_MAXAGE: "31536000"
      DS_LOG_LEVEL: "WARN"
      
      # Connection timeout settings
      NGINX_CLIENT_MAX_BODY_SIZE: "100m"
      NGINX_PROXY_TIMEOUT: "120s"
      NGINX_SEND_TIMEOUT: "120s"
      NGINX_READ_TIMEOUT: "120s"
      
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_logs:/var/log/onlyoffice
      - onlyoffice_cache:/var/lib/onlyoffice
      - onlyoffice_fonts:/usr/share/fonts/truetype/custom
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.onlyoffice.rule=Host(`${ONLYOFFICE_DOMAIN}`)"
      - "traefik.http.routers.onlyoffice.entrypoints=websecure"
      - "traefik.http.routers.onlyoffice.tls.certresolver=le"
      - "traefik.http.routers.onlyoffice.service=onlyoffice"
      - "traefik.http.services.onlyoffice.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik"
      # Security headers
      - "traefik.http.routers.onlyoffice.middlewares=onlyoffice-headers"
      - "traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Forwarded-For=$$remote_addr"
      - "traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Forwarded-Host=${ONLYOFFICE_DOMAIN}"
      - "traefik.http.middlewares.onlyoffice-headers.headers.customrequestheaders.X-Real-IP=$$remote_addr"
      # autoheal
      - "autoheal=true"
    networks:
      - traefik
      - nextcloud_network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Nextcloud - File Management & Collaboration Platform
  app:
    image: nextcloud:32-apache
    restart: always
    depends_on:
      - redis
      - documentserver
    environment:
      # Database Configuration
      POSTGRES_HOST: ${PG_HOST}
      POSTGRES_DB: ${NEXTCLOUD_DB_NAME}
      POSTGRES_USER: ${NEXTCLOUD_DB_USER}
      POSTGRES_PASSWORD: ${NEXTCLOUD_DB_PASSWORD}
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_HOST_PORT: 6379
      REDIS_HOST_PASSWORD: ${REDIS_PASSWORD}
      
      # Domain Configuration
      NEXTCLOUD_TRUSTED_DOMAINS: ${NEXTCLOUD_DOMAIN}
      OVERWRITEPROTOCOL: https
      OVERWRITEHOST: ${NEXTCLOUD_DOMAIN}
      OVERWRITECLIURL: https://${NEXTCLOUD_DOMAIN}
      
      # Reverse Proxy Configuration
      TRUSTED_PROXIES: ${TRUSTED_PROXIES}
      APACHE_DISABLE_REWRITE_IP: 1
      
      # Phone Region Configuration
      DEFAULT_PHONE_REGION: ${DEFAULT_PHONE_REGION}
      
      # Admin User (Initial Setup)
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}
      
      # S3 Storage Configuration
      OBJECTSTORE_S3_HOST: ${S3_ENDPOINT_HOST}
      OBJECTSTORE_S3_BUCKET: ${S3_BUCKET}
      OBJECTSTORE_S3_KEY: ${S3_ACCESS_KEY}
      OBJECTSTORE_S3_SECRET: ${S3_SECRET_KEY}
      OBJECTSTORE_S3_PORT: 443
      OBJECTSTORE_S3_SSL: true
      OBJECTSTORE_S3_REGION: ${S3_REGION}
      OBJECTSTORE_S3_USEPATH_STYLE: false
      
      # SMTP Configuration
      SMTP_HOST: ${SMTP_HOST}
      SMTP_SECURE: tls
      SMTP_PORT: ${SMTP_PORT}
      SMTP_AUTHTYPE: LOGIN
      SMTP_NAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_DOMAIN: ${MAIL_DOMAIN}
      # Talk HPB env (also used by configuration script via container env)
      TALK_HOST: ${TALK_HOST}
      TALK_PORT: ${TALK_PORT}
      TURN_SECRET: ${TURN_SECRET}
      SIGNALING_SECRET: ${SIGNALING_SECRET}
      INTERNAL_SECRET: ${INTERNAL_SECRET}
      
      # Apache Configuration
      APACHE_BODY_LIMIT: 2147483648
      
      # Fontconfig cache directory (writable location)
      FONTCONFIG_PATH: /var/www/.cache/fontconfig
      XDG_CACHE_HOME: /var/www/.cache

    volumes:
      - nextcloud_data:/var/www/html
      - nextcloud_fontcache:/var/cache/fontconfig
      - nextcloud_wwwcache:/var/www/.cache      
      - ./nextcloud-custom.ini:/usr/local/etc/php/conf.d/nextcloud-custom.ini:ro
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`${NEXTCLOUD_DOMAIN}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls.certresolver=le"
      - "traefik.http.routers.nextcloud.service=nextcloud"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik"
      # Nextcloud-specific middlewares
      - "traefik.http.routers.nextcloud.middlewares=nextcloud-dav,nextcloud-headers"
      # DAV redirect middleware
      - "traefik.http.middlewares.nextcloud-dav.redirectregex.regex=^https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-dav.redirectregex.replacement=https://$$1/remote.php/dav/"
      # Security headers
      - "traefik.http.middlewares.nextcloud-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.nextcloud-headers.headers.customrequestheaders.X-Forwarded-For=$$remote_addr"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsseconds=31536000"
      - "traefik.http.middlewares.nextcloud-headers.headers.referrerpolicy=no-referrer"
      
      # watchtower configuration
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=infrastructure"
      # autoheal
      - "autoheal=true"
    networks:
      - traefik
      - nextcloud_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Nextcloud Cron - Background job processing
  cron:
    image: nextcloud:32-apache
    restart: always
    depends_on:
      - app
    volumes:
      - nextcloud_data:/var/www/html
    entrypoint: /cron.sh
    networks:
      - nextcloud_network

  # Nextcloud Talk HPB (TURN/STUN + Janus signaling)
  talk_hpb:
    image: ghcr.io/nextcloud-releases/aio-talk:latest
    container_name: talk_hpb
    restart: unless-stopped
    # Wrapper entrypoint: run the image's start.sh, then patch eturnal config
    # to use the public IP for TURN relay (Docker internal IP is unreachable from clients)
    # and constrain the relay port range to match the mapped ports below.
    entrypoint:
      - /bin/bash
      - -c
      - |
        /start.sh
        PUBLIC_IP=$$(dig "$${TALK_HOST}" IN A +short +search | grep '^[0-9.]\+$$' | head -n1)
        if [ -n "$$PUBLIC_IP" ]; then
          sed -i "s|relay_ipv4_addr:.*|relay_ipv4_addr: \"$$PUBLIC_IP\"|" /conf/eturnal.yml
        fi
        sed -i '/secret:/a\  relay_min_port: 49152\n  relay_max_port: 49252' /conf/eturnal.yml
        exec /usr/bin/supervisord -c /supervisord.conf
    environment:
      - NC_DOMAIN=${NEXTCLOUD_DOMAIN}
      - TALK_HOST=${TALK_HOST}
      - TALK_PORT=${TALK_PORT}
      - TURN_SECRET=${TURN_SECRET}
      - SIGNALING_SECRET=${SIGNALING_SECRET}
      - INTERNAL_SECRET=${INTERNAL_SECRET}
      - TZ=${TZ}
    # TURN control port + relay port range must be internet-facing
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49152-49252:49152-49252/udp"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.talk-signal.rule=Host(`${TALK_HOST}`)"
      - "traefik.http.routers.talk-signal.entrypoints=websecure"
      - "traefik.http.routers.talk-signal.tls.certresolver=le"
      - "traefik.http.routers.talk-signal.service=talk-signal"
      # Force HTTP/1.1 via ALPN - required for WebSocket upgrade (prevents 426 errors)
      - "traefik.http.routers.talk-signal.tls.options=websocket@file"
      - "traefik.http.services.talk-signal.loadbalancer.server.port=8081"
      - "traefik.docker.network=traefik"
      # autoheal
      - "autoheal=true"
    networks:
      - traefik
      - nextcloud_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/api/v1/welcome"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  redis_data:
  nextcloud_data:
  nextcloud_fontcache:
  nextcloud_wwwcache:
  onlyoffice_data:
  onlyoffice_logs:
  onlyoffice_cache:
  onlyoffice_fonts:

networks:
  traefik:
    external: true
  nextcloud_network:
    driver: bridge