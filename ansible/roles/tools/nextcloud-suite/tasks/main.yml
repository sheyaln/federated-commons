---
- name: Ensure Nextcloud Suite deployment directory
  ansible.builtin.file:
    path: /opt/nextcloud-suite
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Deploy docker-compose stack definition
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: /opt/nextcloud-suite/docker-compose.yml
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Deploy Nextcloud PHP configuration
  ansible.builtin.copy:
    src: nextcloud-custom.ini
    dest: /opt/nextcloud-suite/nextcloud-custom.ini
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Copy configure-nextcloud.sh to server
  ansible.builtin.copy:
    src: configure-nextcloud.sh
    dest: /usr/local/bin/configure-nextcloud.sh
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Render environment configuration
  ansible.builtin.template:
    src: env.j2
    dest: /opt/nextcloud-suite/.env
    owner: ubuntu
    group: ubuntu
    mode: '0600'

- name: Check for existing Nextcloud containers
  community.docker.docker_container_info:
    name: nextcloud-app
  register: nextcloud_container
  ignore_errors: true

- name: Stop existing Nextcloud containers
  community.docker.docker_compose_v2:
    project_src: /opt/nextcloud-suite
    state: absent
  when: nextcloud_container.exists and nextcloud_force_recreate | default(false)

- name: Deploy Nextcloud Suite using Docker Compose
  community.docker.docker_compose_v2:
    project_src: /opt/nextcloud-suite
    state: present
    pull: "always"
  register: nextcloud_deployment

- name: Verify database connectivity after deployment
  ansible.builtin.shell: |
    # Wait for containers to start
    sleep 10
    
    # Show container environment for debugging
    echo "ðŸ” Container environment variables:"
    docker exec nextcloud-suite-nextcloud-app-1 env | grep POSTGRES | sed 's/PASSWORD=.*/PASSWORD=***HIDDEN***/'
    echo ""
    
    # Test database authentication using PHP with environment variables
    echo "Testing database connectivity and authentication..."
    docker exec nextcloud-suite-nextcloud-app-1 php -r '
      $host = getenv("POSTGRES_HOST");
      $port = getenv("POSTGRES_PORT") ?: "5432";
      $dbname = getenv("POSTGRES_DB");
      $user = getenv("POSTGRES_USER");
      $password = getenv("POSTGRES_PASSWORD");
      
      echo "Attempting connection to: $host:$port/$dbname as $user\n";
      
      try {
        $pdo = new PDO("pgsql:host=$host;port=$port;dbname=$dbname", $user, $password);
        echo "âœ… Database connectivity and authentication successful\n";
        echo "ðŸ”— Connected to: $host:$port/$dbname as $user\n";
      } catch (Exception $e) {
        echo "âŒ Database connection failed: " . $e->getMessage() . "\n";
        echo "ðŸ’¡ Check: Database credentials in Scaleway Secret Manager\n";
        exit(1);
      }
    '
  register: db_connectivity_test
  failed_when: false
  
- name: Display database test results
  ansible.builtin.debug:
    msg:
      - "Database Test Results:"
      - "{{ db_connectivity_test.stdout }}"
      - "Return Code: {{ db_connectivity_test.rc }}"
  when: db_connectivity_test.rc == 0

- name: Display database troubleshooting info
  ansible.builtin.debug:
    msg:
      - "âŒ Database Authentication Failed!"
      - "{{ db_connectivity_test.stdout }}"
      - ""
      - "ðŸ”§ Next Steps:"
      - "1. Check the 'postgres-nextcloud-credentials' secret in Scaleway Secret Manager"
      - "2. Verify database user and password are correct"
      - "3. Ensure the PostgreSQL user has proper permissions"
      - "4. Check database exists and is accessible"
  when: db_connectivity_test.rc != 0

- name: Install jq for JSON parsing in configuration script
  ansible.builtin.apt:
    name: jq
    state: present
    update_cache: true

- name: Wait for Nextcloud to be ready
  ansible.builtin.uri:
    url: "https://{{ nextcloud_domain | default('cloud.' + tools_domain) }}/status.php"
    method: GET
    validate_certs: false
    status_code: [200]
  register: nextcloud_status
  until: nextcloud_status.status == 200
  retries: 5
  delay: 5

- name: Wait for OnlyOffice Document Server to be ready
  ansible.builtin.uri:
    url: "https://{{ onlyoffice_domain | default('docs.' + tools_domain) }}/healthcheck"
    method: GET
    validate_certs: false
    status_code: [200]
  register: onlyoffice_status
  until: onlyoffice_status.status == 200
  retries: 30
  delay: 10

- name: Configure Nextcloud apps and settings
  ansible.builtin.script: >
    configure-nextcloud.sh
    "{{ nextcloud_domain | default('cloud.' + tools_domain) }}"
    "{{ onlyoffice_domain | default('docs.' + tools_domain) }}"
    "{{ jwt_secret | default('') }}"
    "{{ nextcloud_admin_user | default('obs-admin') }}"
    "{{ nextcloud_admin_password }}"
    "{{ oidc_client_id | default('') }}"
    "{{ oidc_client_secret | default('') }}"
    "{{ oidc_issuer | default('https://' + gateway_domain + '/application/o/sabo-cloud') }}"
    "{{ n8n_form_webhook_url | default('') }}"
  # when: nextcloud_status is succeeded and onlyoffice_status is succeeded

- name: Display deployment summary
  ansible.builtin.debug:
    msg:
      - "Sabo Cloud (Nextcloud) has been deployed successfully!"
      - "Instance URL: https://{{ nextcloud_domain | default('cloud.' + tools_domain) }}"
      - "OnlyOffice Docs URL: https://{{ onlyoffice_domain | default('docs.' + tools_domain) }}"
      - "Talk HPB URL: https://{{ talk_host | default('signal.' + tools_domain) }}"
      - "Admin User: {{ nextcloud_admin_user | default('admin') }}"
      - "Features: File sync/share + Document editing + Talk HPB + OIDC authentication"
      - "Storage: S3 ({{ s3_bucket | default(project_name + '-nextcloud-prod-0') }})"
      - "Database: PostgreSQL (Managed Scaleway)"
      - ""
      - "Next Steps:"
      - "1. Login to Sabo Cloud with admin credentials"
      - "2. Configure OIDC settings in Admin > SSO & SAML authentication"
      - "3. Test video calls using Talk with HPB (High Performance Backend)"
      - "4. Test document editing functionality"