x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "20m"
    max-file: "10"
    compress: "true"

# Port configuration differs between images:
#   Custom build:  IMAP 1143, SMTP 1025 (Proton Bridge defaults)
#   Prebuilt:      IMAP 143,  SMTP 25   (shenxn defaults)
# We standardize the external interface via environment variables

services:
  protonmail-bridge:
{% if protonmail_use_prebuilt | default(false) %}
    # Using prebuilt shenxn/protonmail-bridge image
    # Internal ports: IMAP 143, SMTP 25
    image: shenxn/protonmail-bridge:{{ protonmail_prebuilt_tag | default('latest') }}
{% else %}
    # Building custom image from official Proton .deb package
    # Internal ports: IMAP 1143, SMTP 1025
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BRIDGE_VERSION: {{ protonmail_bridge_version | default('3.13.0-1') }}
{% endif %}
    container_name: protonmail-bridge
    restart: unless-stopped
    # --------------------------------------------------------------------
    # NETWORK EXPOSURE
    # --------------------------------------------------------------------
    # Currently only exposed via Docker network. Other containers connect via:
    #   Host: protonmail-bridge
{% if protonmail_use_prebuilt | default(false) %}
    #   IMAP: 143
    #   SMTP: 25
{% else %}
    #   IMAP: 1143
    #   SMTP: 1025
{% endif %}
    #
    # To expose on Scaleway private network (for cross-server access),
    # uncomment the 'ports' section below:
    # --------------------------------------------------------------------
    # ports:
    #   # Bind to private Scaleway network interface only (NOT public internet)
{% if protonmail_use_prebuilt | default(false) %}
    #   - "{{ scaleway_private_ip | default('10.70.96.1') }}:1143:143"
    #   - "{{ scaleway_private_ip | default('10.70.96.1') }}:1025:25"
{% else %}
    #   - "{{ scaleway_private_ip | default('10.70.96.1') }}:1143:1143"
    #   - "{{ scaleway_private_ip | default('10.70.96.1') }}:1025:1025"
{% endif %}
    expose:
{% if protonmail_use_prebuilt | default(false) %}
      - "143"
      - "25"
{% else %}
      - "1143"
      - "1025"
{% endif %}
    volumes:
{% if protonmail_use_prebuilt | default(false) %}
      # shenxn/protonmail-bridge uses /root for all data
      - protonmail_data:/root
{% else %}
      # Custom build uses separate directories under bridge user
      - protonmail_config:/home/bridge/.config/protonmail/bridge-v3
      - protonmail_data:/home/bridge/.local/share/protonmail/bridge-v3
      - protonmail_cache:/home/bridge/.cache/protonmail/bridge-v3
      - protonmail_gnupg:/home/bridge/.gnupg
      - protonmail_pass:/home/bridge/.password-store
{% endif %}
    environment:
      - TZ={{ timezone | default('America/New_York') }}
    networks:
      - protonmail
    labels:
      - "traefik.enable=false"
      - "com.centurylinklabs.watchtower.enable=false"
    security_opt:
      - no-new-privileges:true
    healthcheck:
{% if protonmail_use_prebuilt | default(false) %}
      test: ["CMD-SHELL", "nc -z localhost 143 && nc -z localhost 25 || exit 1"]
{% else %}
      test: ["CMD-SHELL", "nc -z localhost 1143 && nc -z localhost 1025 || exit 1"]
{% endif %}
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging: *default-logging

volumes:
{% if protonmail_use_prebuilt | default(false) %}
  protonmail_data:
{% else %}
  protonmail_config:
  protonmail_data:
  protonmail_cache:
  protonmail_gnupg:
  protonmail_pass:
{% endif %}

networks:
  protonmail:
    name: protonmail
    driver: bridge




