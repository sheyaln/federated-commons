---
- name: Ensure protonmail-bridge directory
  ansible.builtin.file:
    path: /opt/protonmail-bridge
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Deploy init script
  ansible.builtin.copy:
    src: protonmail-init.sh
    dest: /opt/protonmail-bridge/protonmail-init.sh
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Deploy entrypoint script (for custom build)
  ansible.builtin.copy:
    src: entrypoint.sh
    dest: /opt/protonmail-bridge/entrypoint.sh
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  when: not (protonmail_use_prebuilt | default(false))

- name: Generate docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/protonmail-bridge/docker-compose.yml
    mode: '0644'
    owner: ubuntu
    group: ubuntu
  register: compose_changed

- name: Generate Dockerfile (for custom build)
  ansible.builtin.template:
    src: Dockerfile.j2
    dest: /opt/protonmail-bridge/Dockerfile
    mode: '0644'
    owner: ubuntu
    group: ubuntu
  register: dockerfile_changed
  when: not (protonmail_use_prebuilt | default(false))

- name: Check for existing protonmail-bridge container
  community.docker.docker_container_info:
    name: protonmail-bridge
  register: protonmail_container
  ignore_errors: true

- name: Shut down existing container if config changed
  community.docker.docker_compose_v2:
    project_src: /opt/protonmail-bridge
    state: absent
  when: >
    (protonmail_container.exists | default(false)) and
    (compose_changed.changed or (dockerfile_changed.changed | default(false)))

# --- Custom Build Deployment (with fallback) ---
- name: Try custom build deployment
  when: not (protonmail_use_prebuilt | default(false))
  block:
    - name: Build and start protonmail-bridge (custom image)
      community.docker.docker_compose_v2:
        project_src: /opt/protonmail-bridge
        state: present
        build: always
      register: custom_build_result

  rescue:
    - name: Custom build failed - falling back to prebuilt image
      ansible.builtin.debug:
        msg: |
          Custom build failed. Switching to shenxn/protonmail-bridge prebuilt image.
          Error: {{ custom_build_result.msg | default('Unknown error') }}

    - name: Set fallback flag
      ansible.builtin.set_fact:
        protonmail_use_prebuilt: true

    - name: Regenerate docker-compose for prebuilt image
      ansible.builtin.template:
        src: docker-compose.yml.j2
        dest: /opt/protonmail-bridge/docker-compose.yml
        mode: '0644'
        owner: ubuntu
        group: ubuntu

    - name: Deploy with prebuilt image (fallback)
      community.docker.docker_compose_v2:
        project_src: /opt/protonmail-bridge
        state: present
        pull: always

# --- Prebuilt Image Deployment ---
- name: Deploy prebuilt protonmail-bridge image
  community.docker.docker_compose_v2:
    project_src: /opt/protonmail-bridge
    state: present
    pull: always
  when: protonmail_use_prebuilt | default(false)

- name: Display post-deployment instructions
  ansible.builtin.debug:
    msg: |
      Proton Mail Bridge deployed successfully.
      Image type: {{ 'Prebuilt (shenxn/protonmail-bridge)' if (protonmail_use_prebuilt | default(false)) else 'Custom build' }}
      
      IMPORTANT: First-time setup requires manual authentication.
      
      SSH into the server and run the interactive setup script:
      
        cd /opt/protonmail-bridge && ./protonmail-init.sh
      
      This will guide you through:
        1. Logging into your Proton Mail account (with 2FA if enabled)
        2. Retrieving the bridge-generated IMAP/SMTP credentials
      
      After setup, other containers can connect via the 'protonmail' Docker network:
        Host: protonmail-bridge
        IMAP: {{ '143' if (protonmail_use_prebuilt | default(false)) else '11143' }}
        SMTP: {{ '25' if (protonmail_use_prebuilt | default(false)) else '11025' }}
        Username: Your Proton email address
        Password: Bridge-generated password (shown in 'info' output)
        Security: STARTTLS (port 143/1143) or SSL/TLS
      
      For n8n, set 'enable_protonmail: true' in group_vars and redeploy.




