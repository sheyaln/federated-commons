# Build stage for web frontend
FROM node:18-slim AS web-builder

WORKDIR /app
COPY web-src/package*.json ./web-src/
RUN cd web-src && npm install

COPY web-src ./web-src
ENV NODE_OPTIONS=--openssl-legacy-provider
RUN cd web-src && npm run build

# Runtime stage
FROM python:3.9-slim

WORKDIR /app

# Install system dependencies and Docker CLI
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    openssh-client \
    ca-certificates \
    gnupg \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bookworm stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends docker-ce-cli \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional dependencies for custom scripts
RUN pip install --no-cache-dir requests

# Copy application code
COPY launcher.py .
COPY src ./src

# Copy built web files from builder stage
COPY --from=web-builder /app/web ./web

# Create necessary directories
RUN mkdir -p /app/conf/runners /app/conf/scripts /app/conf/schedules

# Create SSH directory
RUN mkdir -p /root/.ssh && chmod 700 /root/.ssh

# Copy entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose port
EXPOSE {{ wobbler_port }}

ENTRYPOINT ["/entrypoint.sh"]
CMD ["python3", "launcher.py"]

