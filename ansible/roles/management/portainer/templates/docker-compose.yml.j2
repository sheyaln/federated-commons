services:
  # Docker Socket Proxy for Portainer - Security layer
  portainer-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: portainer-socket-proxy
    restart: unless-stopped
    cap_add:
      - CAP_NET_BIND_SERVICE
    cap_drop:
      - ALL
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Enable endpoints needed for Portainer management interface
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - NODES=1
      - NETWORKS=1
      - VOLUMES=1
      - IMAGES=1
      - INFO=1
      - SWARM=1
      - SYSTEM=1
      - EVENTS=1
      - POST=1          # Required for container management
      - DELETE=1        # Required for resource deletion
      - PUT=1           # Required for resource updates
      - PATCH=0         # Not needed for basic operations
      - EXEC=1          # Required for container exec functionality
      - SECRETS=1       # Required for Docker secrets management
      - CONFIGS=1       # Required for Docker configs management
      - PLUGINS=1       # Required for plugin management
      - DISTRIBUTION=0  # Not needed
      - AUTH=0          # Not needed
      - BUILD=1         # Required for image building
      - COMMIT=1        # Required for image operations
      - GRPC=0
      - SESSION=0
      - LOG_LEVEL=info
    ports:
      - "127.0.0.1:2377:2375"
    networks:
      - portainer_network
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    user: "65534:65534"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    depends_on:
      - portainer-socket-proxy
    # SECURITY FIX: Use Docker Socket Proxy instead of direct socket access
    environment:
      - DOCKER_HOST=tcp://portainer-socket-proxy:2375
    volumes:
      - portainer_data:/data
    security_opt:
      - no-new-privileges:true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.{{ management_domain }}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=le"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.docker.network=traefik"
      # Watchtower labels
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=production"
    networks:
      - traefik
      - portainer_network

volumes:
  portainer_data:

networks:
  traefik:
    external: true
  portainer_network:
    driver: bridge 