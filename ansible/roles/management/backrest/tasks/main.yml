---
- name: Ensure backrest directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu
  loop:
    - "{{ backrest_app_path }}"
    - "{{ backrest_app_path }}/data"
    - "{{ backrest_app_path }}/config"
    - "{{ backrest_app_path }}/cache"

# SSH key for SFTP access to remote servers.
# The vieux/sshfs Docker plugin only has access to /root/.ssh on the host,
# so the key must be placed there for SSHFS volume mounts to work.
- name: Ensure /root/.ssh directory exists
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: Deploy backup SSH private key for SSHFS plugin
  ansible.builtin.copy:
    content: "{{ backrest_ssh_private_key }}{{ '' if backrest_ssh_private_key.endswith('\n') else '\n' }}"
    dest: /root/.ssh/backrest_ed25519
    mode: '0600'
    owner: root
    group: root
  no_log: true

# Docker SSHFS volume plugin for remote server mounts.
# The plugin must have its sshkey source set to /root/.ssh so it can
# access the SSH private key for SFTP connections.
- name: Install vieux/sshfs Docker volume plugin
  community.docker.docker_plugin:
    plugin_name: vieux/sshfs
    state: present
  register: sshfs_plugin_install

- name: Configure SSHFS plugin SSH key mount source
  ansible.builtin.shell: |
    docker plugin disable vieux/sshfs -f 2>/dev/null || true
    docker plugin set vieux/sshfs sshkey.source=/root/.ssh
    docker plugin enable vieux/sshfs
  changed_when: sshfs_plugin_install.changed

- name: Ensure SSHFS plugin is enabled
  community.docker.docker_plugin:
    plugin_name: vieux/sshfs
    state: enable

# Deploy initial Backrest config (only if no config exists yet)
- name: Check if Backrest config already exists
  ansible.builtin.stat:
    path: "{{ backrest_app_path }}/config/config.json"
  register: backrest_config_stat

- name: Deploy initial Backrest config
  ansible.builtin.template:
    src: config.json.j2
    dest: "{{ backrest_app_path }}/config/config.json"
    mode: '0644'
    owner: ubuntu
    group: ubuntu
  when: not backrest_config_stat.stat.exists
  register: config_changed

- name: Generate docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ backrest_app_path }}/docker-compose.yml"
    mode: '0644'
    owner: ubuntu
    group: ubuntu
  register: compose_changed

- name: Render environment file
  ansible.builtin.template:
    src: env.j2
    dest: "{{ backrest_app_path }}/.env"
    mode: '0600'
    owner: ubuntu
    group: ubuntu
  register: env_changed

- name: Check for existing backrest container
  community.docker.docker_container_info:
    name: backrest
  register: backrest_container
  ignore_errors: true

- name: Shut down existing backrest containers
  community.docker.docker_compose_v2:
    project_src: "{{ backrest_app_path }}"
    state: absent
  when: >
    backrest_container.exists | default(false) and
    (compose_changed.changed or env_changed.changed or config_changed.changed | default(false))

- name: Ensure backrest containers are running
  community.docker.docker_compose_v2:
    project_src: "{{ backrest_app_path }}"
    state: present
    pull: always
