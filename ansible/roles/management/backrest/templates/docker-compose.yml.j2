x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  backrest:
    image: garethgeorge/backrest:latest
    container_name: backrest
    hostname: backrest
    restart: unless-stopped
    volumes:
      - ./data:/data
      - ./config:/config
      - ./cache:/cache
      # Management server local mounts
      - /var/lib/docker/volumes:/backup-sources/docker-volumes:ro
      - /opt:/backup-sources/opt:ro
      # Remote server SSHFS mounts
      - sshfs-tools-prod-volumes:/backup-sources/tools-prod/docker-volumes:ro
      - sshfs-tools-prod-opt:/backup-sources/tools-prod/opt:ro
      - sshfs-authentik-prod-volumes:/backup-sources/authentik-prod/docker-volumes:ro
      - sshfs-authentik-prod-opt:/backup-sources/authentik-prod/opt:ro
    env_file: .env
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backrest.rule=Host(`backrest.{{ management_domain }}`)"
      - "traefik.http.routers.backrest.entrypoints=websecure"
      - "traefik.http.routers.backrest.tls.certresolver=le"
      - "traefik.http.routers.backrest.middlewares=authentik-auth@docker"
      - "traefik.http.services.backrest.loadbalancer.server.port=9898"
      - "traefik.docker.network=traefik"
      - "com.centurylinklabs.watchtower.enable=false"
    security_opt:
      - no-new-privileges:true
    logging: *default-logging

networks:
  traefik:
    external: true

# SSHFS volumes for remote server backup via Wobbler SSH key
volumes:
  sshfs-tools-prod-volumes:
    driver: vieux/sshfs
    driver_opts:
      sshcmd: "ubuntu@{{ tools_prod_ip }}:/var/lib/docker/volumes"
      IdentityFile: "/root/.ssh/backrest_ed25519"
      allow_other: ""
      reconnect: ""
      StrictHostKeyChecking: "no"
      ServerAliveInterval: "15"
      ServerAliveCountMax: "3"

  sshfs-tools-prod-opt:
    driver: vieux/sshfs
    driver_opts:
      sshcmd: "ubuntu@{{ tools_prod_ip }}:/opt"
      IdentityFile: "/root/.ssh/backrest_ed25519"
      allow_other: ""
      reconnect: ""
      StrictHostKeyChecking: "no"
      ServerAliveInterval: "15"
      ServerAliveCountMax: "3"

  sshfs-authentik-prod-volumes:
    driver: vieux/sshfs
    driver_opts:
      sshcmd: "ubuntu@{{ authentik_prod_ip }}:/var/lib/docker/volumes"
      IdentityFile: "/root/.ssh/backrest_ed25519"
      allow_other: ""
      reconnect: ""
      StrictHostKeyChecking: "no"
      ServerAliveInterval: "15"
      ServerAliveCountMax: "3"

  sshfs-authentik-prod-opt:
    driver: vieux/sshfs
    driver_opts:
      sshcmd: "ubuntu@{{ authentik_prod_ip }}:/opt"
      IdentityFile: "/root/.ssh/backrest_ed25519"
      allow_other: ""
      reconnect: ""
      StrictHostKeyChecking: "no"
      ServerAliveInterval: "15"
      ServerAliveCountMax: "3"
