---
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "5"
    compress: "true"

services:
  # Docker Socket Proxy - Security layer for Docker API access (SECURITY CRITICAL)
  # Limits Traefik to read-only container discovery, blocks dangerous APIs
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: authentik-traefik-socket-proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CONTAINERS=1
      - NETWORKS=1
      - SERVICES=1
      - TASKS=1
      - VOLUMES=1
    ports:
      - "127.0.0.1:2376:2375"
    networks:
      - traefik
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=infrastructure"
    logging: *default-logging

  traefik:
    image: traefik:v3.1
    container_name: traefik-authentik
    restart: unless-stopped
    depends_on:
      - docker-socket-proxy
    command:
      # API and Dashboard
      - --api=false
      - --ping=true
      - --global.sendAnonymousUsage=false
      - --global.checkNewVersion=false

      # Providers
      - --providers.docker=true
      - --providers.docker.endpoint=tcp://docker-socket-proxy:2375
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=traefik
      - --providers.file.directory=/config/dynamic
      - --providers.file.watch=true

      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # Trust forwarded headers from management/tools servers for forward auth
      - --entrypoints.websecure.forwardedHeaders.insecure=true

      # ACME/Let's Encrypt - Production ready
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=${TRAEFIK_ACME_EMAIL}
      - --certificatesresolvers.le.acme.storage=/data/acme.json
      - --certificatesresolvers.le.acme.caserver=https://acme-v02.api.letsencrypt.org/directory

      # Logging
      - --log.level=INFO
      - --log.filepath=/logs/traefik.log
      - --log.format=json
      - --accesslog=true
      - --accesslog.filepath=/logs/access.log
      - --accesslog.format=json
      - --accesslog.bufferingsize=100
      - --accesslog.fields.defaultmode=keep
      - --accesslog.fields.headers.defaultmode=drop

      # Security
      - --serverstransport.insecureskipverify=false

      # Metrics
      - --metrics.prometheus=true
      - --metrics.prometheus.buckets=0.1,0.3,1.2,5.0
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.prometheus.addServicesLabels=true
      - --metrics.prometheus.entryPoint=metrics
      - --entrypoints.metrics.address=:9102

    ports:
      - "80:80"
      - "443:443"
      - "${PRIVATE_IP:-0.0.0.0}:9102:9102"

    volumes:
      # Docker socket access is now via docker-socket-proxy (more secure)
      - ./data:/data
      - ./logs:/logs
      - ./config:/config:ro

    networks:
      - traefik

    environment:
      - TRAEFIK_ACME_EMAIL=${TRAEFIK_ACME_EMAIL}

    env_file:
      - .env

    security_opt:
      - no-new-privileges:true

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "com.centurylinklabs.watchtower.enable=false"
      - "autoheal=false"

      # Global HTTP to HTTPS redirect - but with lower priority than ACME
      # Note: v3 HostRegexp syntax - no named capture groups
      - "traefik.http.routers.http-redirect.rule=HostRegexp(`.+`)"
      - "traefik.http.routers.http-redirect.entrypoints=web"
      - "traefik.http.routers.http-redirect.middlewares=redirect-to-https"
      - "traefik.http.routers.http-redirect.priority=1"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging: *default-logging

networks:
  traefik:
    external: true
