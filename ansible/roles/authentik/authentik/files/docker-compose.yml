---
services:
  server:
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.12.1}
    container_name: authentik-server
    restart: unless-stopped
    command: server
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_POSTGRESQL__HOST: ${POSTGRES_HOST}
      AUTHENTIK_POSTGRESQL__PORT: ${POSTGRES_PORT}
      AUTHENTIK_POSTGRESQL__USER: ${POSTGRES_USER}
      AUTHENTIK_POSTGRESQL__NAME: ${POSTGRES_DB}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./data:/data
      - ./custom-templates:/templates
    env_file:
      - .env
    ports:
      - "127.0.0.1:9000:9000"
      - "${PRIVATE_IP:-0.0.0.0}:9300:9300"
    healthcheck:
      test: ["CMD-SHELL", "ak healthcheck"]
      start_period: 90s
      interval: 30s
      retries: 10
      timeout: 10s
    networks:
      - authentik-internal
      - traefik
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # Main Authentik web interface service
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      - "traefik.http.services.authentik.loadbalancer.healthcheck.path=/api/v3/root/config/"
      - "traefik.http.services.authentik.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.authentik.loadbalancer.healthcheck.timeout=10s"

      # SINGLE MAIN ROUTER - handles both web interface and outpost endpoints
      - "traefik.http.routers.authentik-main.rule=Host(`${AUTHENTIK_DOMAIN}`)"
      - "traefik.http.routers.authentik-main.entrypoints=websecure"
      - "traefik.http.routers.authentik-main.tls=true"
      - "traefik.http.routers.authentik-main.tls.certresolver=le"
      - "traefik.http.routers.authentik-main.service=authentik"
      - "traefik.http.routers.authentik-main.middlewares=security-headers@file"
      - "traefik.http.routers.authentik-main.priority=10"

      # ForwardAuth middleware for other apps to authenticate via Authentik
      # Apps can use: traefik.http.routers.myapp.middlewares=authentik@docker
      - "traefik.http.middlewares.authentik.forwardauth.address=http://authentik-server:9000/outpost.goauthentik.io/auth/traefik"
      - "traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"

      - "com.centurylinklabs.watchtower.enable=false"

  worker:
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.12.1}
    # Note: container_name removed to allow scaling with replicas
    restart: unless-stopped
    command: worker
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_POSTGRESQL__HOST: ${POSTGRES_HOST}
      AUTHENTIK_POSTGRESQL__USER: ${POSTGRES_USER}
      AUTHENTIK_POSTGRESQL__NAME: ${POSTGRES_DB}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${POSTGRES_PASSWORD}
    user: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/data
      - ./certs:/certs
      - ./custom-templates:/templates
    env_file:
      - .env
    depends_on:
      server:
        condition: service_healthy
    networks:
      - authentik-internal
    security_opt:
      - no-new-privileges:true
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

networks:
  authentik-internal:
    external: true
  traefik:
    external: true
