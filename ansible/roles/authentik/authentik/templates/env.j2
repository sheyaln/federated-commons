# Authentik Environment Configuration

# ── Database Configuration ─────────────────────────
POSTGRES_DB={{ POSTGRES_DB }}
POSTGRES_USER={{ POSTGRES_USER }}
POSTGRES_PASSWORD="{{ POSTGRES_PASSWORD | regex_replace('\\$', '$$') }}"
POSTGRES_HOST={{ POSTGRES_HOST }}
POSTGRES_PORT={{ POSTGRES_PORT }}

# ── Authentik Core Configuration ─────────────────────────
AUTHENTIK_SECRET_KEY="{{ AUTHENTIK_SECRET_KEY | regex_replace('\\$', '$$') }}"
AUTHENTIK_IMAGE={{ AUTHENTIK_IMAGE }}
AUTHENTIK_TAG={{ AUTHENTIK_TAG }}

# ── Domain Configuration ─────────────────────────
AUTHENTIK_DOMAIN={{ AUTHENTIK_DOMAIN }}
AUTHENTIK_LEGACY_DOMAIN={{ AUTHENTIK_LEGACY_DOMAIN }}
# ── Bootstrap Admin User ─────────────────────────
AUTHENTIK_BOOTSTRAP_PASSWORD="{{ AUTHENTIK_ADMIN_PASSWORD | regex_replace('\\$', '$$') }}"
AUTHENTIK_BOOTSTRAP_EMAIL={{ AUTHENTIK_ADMIN_EMAIL }}

# ── Database Connection ─────────────────────────
# Note: Redis was removed in authentik 2025.10 - all caching/tasks now use PostgreSQL
AUTHENTIK_POSTGRESQL__HOST={{ POSTGRES_HOST }}
AUTHENTIK_POSTGRESQL__PORT={{ POSTGRES_PORT }}
AUTHENTIK_POSTGRESQL__USER={{ POSTGRES_USER }}
AUTHENTIK_POSTGRESQL__NAME={{ POSTGRES_DB }}
AUTHENTIK_POSTGRESQL__PASSWORD="{{ POSTGRES_PASSWORD | regex_replace('\\$', '$$') }}"

# ── Database Connection Pool Settings ─────────────────────────
# Limit connections to prevent exhausting managed PostgreSQL limits
# CONN_MAX_AGE: How long to keep connections open (seconds, 0=close after each request)
AUTHENTIK_POSTGRESQL__CONN_MAX_AGE=300

# ── Email Configuration ─────────────────────────
{% if AUTHENTIK_SMTP_HOST is defined %}
AUTHENTIK_EMAIL__HOST={{ AUTHENTIK_SMTP_HOST }}
AUTHENTIK_EMAIL__PORT={{ AUTHENTIK_SMTP_PORT | default('465') }}
AUTHENTIK_EMAIL__USERNAME={{ AUTHENTIK_SMTP_USERNAME | default('') }}
AUTHENTIK_EMAIL__PASSWORD={{ AUTHENTIK_SMTP_PASSWORD | default('') }}
AUTHENTIK_EMAIL__FROM="{{ AUTHENTIK_SMTP_FROM | default('') }}"
AUTHENTIK_EMAIL__USE_TLS={{ AUTHENTIK_SMTP_USE_TLS | default('false') }}
AUTHENTIK_EMAIL__USE_SSL={{ AUTHENTIK_SMTP_USE_SSL | default('true') }}
AUTHENTIK_EMAIL__TIMEOUT=10
{% endif %}

# ── Error Reporting & Analytics ─────────────────────────
AUTHENTIK_DISABLE_STARTUP_ANALYTICS=true
AUTHENTIK_DISABLE_UPDATE_CHECK=false
AUTHENTIK_ERROR_REPORTING__ENABLED=false

# ── Logging ─────────────────────────
AUTHENTIK_LOG_LEVEL=info
AUTHENTIK_METRICS__ENABLED=true

# ── Network Configuration ─────────────────────────
AUTHENTIK_NETWORK_INTERNAL=authentik-internal

# ── S3 Storage Configuration ─────────────────────────
{% if AUTHENTIK_STORAGE_BACKEND is defined %}
AUTHENTIK_STORAGE__BACKEND={{ AUTHENTIK_STORAGE_BACKEND }}
AUTHENTIK_STORAGE__S3__ACCESS_KEY={{ AUTHENTIK_STORAGE_S3_ACCESS_KEY }}
AUTHENTIK_STORAGE__S3__SECRET_KEY="{{ AUTHENTIK_STORAGE_S3_SECRET_KEY | regex_replace('\\$', '$$') }}"
AUTHENTIK_STORAGE__S3__BUCKET_NAME={{ AUTHENTIK_STORAGE_S3_BUCKET_NAME }}
AUTHENTIK_STORAGE__S3__REGION={{ AUTHENTIK_STORAGE_S3_REGION }}
AUTHENTIK_STORAGE__S3__ENDPOINT={{ AUTHENTIK_STORAGE_S3_ENDPOINT }}
AUTHENTIK_STORAGE__S3__CUSTOM_DOMAIN={{ AUTHENTIK_STORAGE_S3_CUSTOM_DOMAIN }}
AUTHENTIK_STORAGE__S3__SECURE_URLS={{ AUTHENTIK_STORAGE_S3_SECURE_URLS | default('true') }}
# Required for S3-compatible providers like Scaleway (path-style URLs)
AUTHENTIK_STORAGE__S3__ADDRESSING_STYLE=path
{% endif %}

# ── Private Network IP for Metrics Binding ─────────────────────────
PRIVATE_IP={{ server_ips[server_name] | default('0.0.0.0') }}