#!/bin/bash

# entrypoint-with-secrets - Container entrypoint wrapper

# Fetches secrets from Scaleway Secret Manager before starting the application.
# Designed to be used as the container entrypoint, with the actual command
# passed as arguments.
#
# Usage (in docker-compose.yml):
#   entrypoint: ["/opt/scw-secrets/bin/entrypoint-with-secrets", "outline"]
#   command: ["yarn", "start"]
#
# Environment Variables:
#   SCW_APP_NAME     - Override app name (default: first argument)
#   SCW_SECRETS_DIR  - Override secrets directory (default: /run/secrets)
#   SCW_SKIP_SECRETS - Set to "true" to skip secret fetching
#
# The script will:
#   1. Fetch secrets from Scaleway to /run/secrets (tmpfs)
#   2. Export secrets as environment variables (optional)
#   3. Execute the original command


set -euo pipefail

# Configuration
FETCH_SCRIPT="{{ scw_secrets_bin_dir }}/fetch-secrets"
DEFAULT_SECRETS_DIR="/run/secrets"

# -----------------------------------------------------------------------------
# Parse Arguments
# -----------------------------------------------------------------------------
if [[ $# -lt 1 ]]; then
    echo "ERROR: Usage: entrypoint-with-secrets <app-name> [command...]" >&2
    exit 1
fi

APP_NAME="${SCW_APP_NAME:-$1}"
shift

# Remaining arguments are the command to execute
COMMAND=("$@")

# Override secrets directory if set
SECRETS_DIR="${SCW_SECRETS_DIR:-$DEFAULT_SECRETS_DIR}"

# -----------------------------------------------------------------------------
# Skip Secrets (for local development)
# -----------------------------------------------------------------------------
if [[ "${SCW_SKIP_SECRETS:-false}" == "true" ]]; then
    echo "[entrypoint] Skipping secret fetch (SCW_SKIP_SECRETS=true)"
    exec "${COMMAND[@]}"
fi

# -----------------------------------------------------------------------------
# Ensure Secrets Directory Exists
# -----------------------------------------------------------------------------
if [[ ! -d "$SECRETS_DIR" ]]; then
    echo "[entrypoint] Creating secrets directory: $SECRETS_DIR"
    mkdir -p "$SECRETS_DIR"
    chmod 0700 "$SECRETS_DIR"
fi

# -----------------------------------------------------------------------------
# Fetch Secrets
# -----------------------------------------------------------------------------
echo "[entrypoint] Fetching secrets for: $APP_NAME"

# Use sudo to run as scw-secrets user (has access to the config)
if ! sudo -u {{ scw_secrets_user }} "$FETCH_SCRIPT" "$APP_NAME" "$SECRETS_DIR"; then
    echo "ERROR: Failed to fetch secrets for $APP_NAME" >&2
    exit 1
fi

echo "[entrypoint] Secrets fetched successfully"

# -----------------------------------------------------------------------------
# Export Secrets as Environment Variables (Optional)
# -----------------------------------------------------------------------------
# Applications that support _FILE suffix don't need this.
# For apps that don't, we can export secrets as env vars.

if [[ "${SCW_EXPORT_SECRETS:-false}" == "true" ]]; then
    echo "[entrypoint] Exporting secrets as environment variables"
    for secret_file in "$SECRETS_DIR"/*; do
        if [[ -f "$secret_file" ]]; then
            var_name=$(basename "$secret_file" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            export "$var_name"="$(cat "$secret_file")"
        fi
    done
fi

# -----------------------------------------------------------------------------
# Execute Command
# -----------------------------------------------------------------------------
if [[ ${#COMMAND[@]} -eq 0 ]]; then
    echo "ERROR: No command specified" >&2
    exit 1
fi

echo "[entrypoint] Starting: ${COMMAND[*]}"
exec "${COMMAND[@]}"
