---
# Grant ubuntu user read access to Docker volumes for SFTP-based backups.
# The Backrest instance on the management server mounts these paths over SSHFS
# using the Wobbler SSH key (which authenticates as ubuntu).
# Docker volumes are owned by root, so POSIX ACLs are needed.

- name: Install acl package for POSIX ACL support
  ansible.builtin.apt:
    name: acl
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Grant ubuntu traversal on /var/lib/docker
  ansible.posix.acl:
    path: /var/lib/docker
    entity: ubuntu
    etype: user
    permissions: x
    state: present

- name: Set ACLs on /var/lib/docker/volumes for ubuntu read access
  ansible.posix.acl:
    path: /var/lib/docker/volumes
    entity: ubuntu
    etype: user
    permissions: rX
    recursive: true
    state: present

- name: Set default ACLs on /var/lib/docker/volumes for new entries
  ansible.posix.acl:
    path: /var/lib/docker/volumes
    entity: ubuntu
    etype: user
    permissions: rX
    default: true
    state: present

- name: Deploy ACL refresh script
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Refresh POSIX ACLs on Docker volumes for backup access.
      # Runs periodically via systemd timer to cover new files created by containers.
      set -euo pipefail
      # Ensure traversal on parent directory
      setfacl -m u:ubuntu:x /var/lib/docker 2>/dev/null || true
      # Recursive read ACLs on volumes
      find /var/lib/docker/volumes -type d -exec setfacl -m u:ubuntu:rX {} + 2>/dev/null || true
      find /var/lib/docker/volumes -type f -exec setfacl -m u:ubuntu:r {} + 2>/dev/null || true
      find /var/lib/docker/volumes -type d -exec setfacl -d -m u:ubuntu:rX {} + 2>/dev/null || true
    dest: /usr/local/bin/refresh-backup-acls.sh
    mode: '0755'
    owner: root
    group: root

- name: Deploy systemd service for ACL refresh
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Refresh POSIX ACLs on Docker volumes for backup access

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/refresh-backup-acls.sh
    dest: /etc/systemd/system/backup-acl-refresh.service
    mode: '0644'
    owner: root
    group: root
  notify: reload systemd

- name: Deploy systemd timer for periodic ACL refresh
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Refresh backup ACLs every 4 hours

      [Timer]
      OnCalendar=*-*-* 00/4:00:00
      RandomizedDelaySec=300
      Persistent=true

      [Install]
      WantedBy=timers.target
    dest: /etc/systemd/system/backup-acl-refresh.timer
    mode: '0644'
    owner: root
    group: root
  notify: reload systemd

- name: Enable and start ACL refresh timer
  ansible.builtin.systemd:
    name: backup-acl-refresh.timer
    enabled: true
    state: started
    daemon_reload: true

- name: Trigger immediate ACL refresh via systemd
  ansible.builtin.systemd:
    name: backup-acl-refresh.service
    state: started
