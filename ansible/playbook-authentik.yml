---
# ============================================
# SYSTEM MAINTENANCE & SECURITY
# ============================================

- name: Configure Authentik host - System Updates
  hosts: authentik-prod
  tags: 
    - core
    - system-updates
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/core.yml
    - group-vars/unattended-upgrades.yml
  roles:
    - core/unattended-upgrades

- name: Configure Authentik host - Log Management
  hosts: authentik-prod
  tags:
    - core
    - log-management
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/core.yml
  roles:
    - core/log-management

- name: Configure Authentik host - Security & Firewall
  hosts: authentik-prod
  tags: 
    - core
    - security
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/core.yml
  roles:
    - core/fail2ban
    - core/ufw

# ============================================
# INFRASTRUCTURE SERVICES
# ============================================

- name: Configure Authentik host - Docker Runtime
  hosts: authentik-prod
  tags: 
    - core
    - docker
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/core.yml
  roles:
    - core/docker

- name: Configure Authentik host - Wobbler SSH Access
  hosts: authentik-prod
  tags:
    - core
    - wobbler-access
  become: true
  vars_files:
    - group-vars/all.yml
  roles:
    - core/wobbler-access

- name: Configure Authentik host - Traefik
  hosts: authentik-prod
  tags: traefik
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/traefik-authentik.yml
  roles:
    - authentik/traefik

# ============================================
# MONITORING
# ============================================

- name: Deploy Monitoring Exporters on Authentik host
  hosts: authentik-prod
  tags: 
    - monitoring
    - monitoring-exporters
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/monitoring.yml
  roles:
    - monitoring/exporters

- name: Configure Authentik host - Container Auto-Update & Auto-Heal
  hosts: authentik-prod
  tags: 
    - monitoring
    - autoupdate
    - autoheal
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/monitoring-autoupdate.yml
  roles:
    - core/monitoring-autoupdate

# ============================================
# SECURITY SERVICES
# ============================================

- name: Deploy Security Services - Wazuh Agent
  hosts: authentik-prod
  tags: wazuh-agent
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/wazuh.yml
  roles:
    - core/wazuh-agent

# ============================================
# AUTHENTIK APPLICATION
# ============================================

- name: Configure Authentik host - Authentik
  hosts: authentik-prod
  tags: authentik
  become: true
  vars_files:
    - group-vars/all.yml
    - group-vars/authentik.yml
  roles:
    - authentik/authentik

